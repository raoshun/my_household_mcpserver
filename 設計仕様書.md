# 家計簿分析MCPサーバ 設計仕様書

## 1. プロジェクト概要

### 1.1 目的

家計簿データの分析をAIエージェントとの自然言語会話で実現するMCP（Model Context Protocol）サーバを開発する。ユーザーは複雑なクエリ言語を学ぶことなく、日常会話で家計データの洞察を得ることができる。

### 1.2 主要価値提案

- **直感的インターフェース**: 自然言語による家計分析
- **リアルタイム洞察**: 即座に財務状況を把握
- **プロアクティブ分析**: AIが異常や傾向を自動検出
- **プライバシー保護**: ローカル処理によるデータセキュリティ

### 1.3 対象ユーザー

- 個人・家庭の家計管理者
- 小規模事業主
- ファイナンシャルプランナー（クライアント向け）

## 2. システム要件

### 2.1 機能要件

#### 2.1.1 データ管理機能

- **F001**: 取引データの追加・更新・削除
- **F002**: カテゴリー管理（収入・支出の分類）
- **F003**: アカウント管理（銀行口座、クレジットカード等）
- **F004**: CSV/JSON形式でのデータインポート・エクスポート
- **F005**: 定期取引のテンプレート機能

#### 2.1.2 分析・レポート機能

- **F006**: 月次・年次の収支レポート
- **F007**: カテゴリー別支出分析
- **F008**: トレンド分析（時系列での変化）
- **F009**: 予算vs実績の比較分析
- **F010**: 異常検知（通常パターンからの逸脱）

#### 2.1.3 自然言語インターフェース

- **F011**: 自然言語による質問処理
- **F012**: 分析結果の自然言語での説明生成
- **F013**: グラフ・チャートの自動生成
- **F014**: 提案・推奨事項の生成

#### 2.1.4 予算管理機能

- **F015**: 予算設定・管理
- **F016**: 予算超過アラート
- **F017**: 目標設定と進捗トラッキング

### 2.2 非機能要件

#### 2.2.1 性能要件

- **N001**: 1万件の取引データで1秒以内の応答
- **N002**: 同時ユーザー数: 最大10人（小規模利用想定）
- **N003**: データベースサイズ: 最大1GB

#### 2.2.2 セキュリティ要件

- **N004**: 個人財務データの暗号化保存
- **N005**: アクセス制御（認証・認可）
- **N006**: ローカル処理によるプライバシー保護

#### 2.2.3 可用性要件

- **N007**: 稼働率99%以上
- **N008**: バックアップ・リストア機能

## 3. システムアーキテクチャ

### 3.1 全体アーキテクチャ

```text
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   AIエージェント  │◄──►│  MCPサーバー     │◄──►│  データベース    │
│   (Claude等)    │    │  (家計簿分析)    │    │  (SQLite)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │  分析エンジン    │
                       │  (pandas,       │
                       │   matplotlib)   │
                       └─────────────────┘
```

### 3.2 MCPサーバーコンポーネント

- **接続管理**: AIエージェントとの通信
- **クエリ処理**: 自然言語の意図解析
- **データアクセス**: データベース操作
- **分析エンジン**: 統計・可視化処理
- **応答生成**: 結果の自然言語化

### 3.3 データモデル

#### 3.3.1 取引テーブル (transactions)

```sql
CREATE TABLE transactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    date DATE NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    description TEXT,
    category_id INTEGER,
    account_id INTEGER,
    type TEXT CHECK(type IN ('income', 'expense')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (category_id) REFERENCES categories(id),
    FOREIGN KEY (account_id) REFERENCES accounts(id)
);
```

#### 3.3.2 カテゴリーテーブル (categories)

```sql
CREATE TABLE categories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    type TEXT CHECK(type IN ('income', 'expense')),
    parent_id INTEGER,
    color TEXT,
    icon TEXT,
    FOREIGN KEY (parent_id) REFERENCES categories(id)
);
```

#### 3.3.3 アカウントテーブル (accounts)

```sql
CREATE TABLE accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type TEXT CHECK(type IN ('bank', 'credit', 'cash', 'investment')),
    initial_balance DECIMAL(10,2) DEFAULT 0,
    current_balance DECIMAL(10,2) DEFAULT 0,
    currency TEXT DEFAULT 'JPY',
    is_active BOOLEAN DEFAULT 1
);
```

#### 3.3.4 予算テーブル (budgets)

```sql
CREATE TABLE budgets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    category_id INTEGER,
    amount DECIMAL(10,2) NOT NULL,
    period_type TEXT CHECK(period_type IN ('monthly', 'yearly')),
    start_date DATE,
    end_date DATE,
    FOREIGN KEY (category_id) REFERENCES categories(id)
);
```

## 4. MCPツール仕様

### 4.1 データ操作ツール

#### 4.1.1 add_transaction

**目的**: 新しい取引を追加
**パラメータ**:

- `date` (string): 取引日 (YYYY-MM-DD形式)
- `amount` (number): 金額
- `description` (string): 取引の説明
- `category` (string): カテゴリー名
- `account` (string): アカウント名
- `type` (string): 'income' または 'expense'

#### 4.1.2 update_transaction

**目的**: 既存取引の更新
**パラメータ**:

- `transaction_id` (number): 取引ID
- その他add_transactionと同じ（オプション）

#### 4.1.3 delete_transaction

**目的**: 取引の削除
**パラメータ**:

- `transaction_id` (number): 削除する取引ID

#### 4.1.4 get_transactions

**目的**: 取引データの取得
**パラメータ**:

- `start_date` (string, optional): 開始日
- `end_date` (string, optional): 終了日
- `category` (string, optional): カテゴリーフィルター
- `account` (string, optional): アカウントフィルター
- `limit` (number, optional): 取得件数制限

### 4.2 分析ツール

#### 4.2.1 analyze_spending_by_category

**目的**: カテゴリー別支出分析
**パラメータ**:

- `period` (string): 'month', 'year', 'custom'
- `start_date` (string, optional): 開始日
- `end_date` (string, optional): 終了日
- `chart_type` (string, optional): 'pie', 'bar', 'line'

#### 4.2.2 analyze_income_expense_trend

**目的**: 収支トレンド分析
**パラメータ**:

- `period` (string): 分析期間
- `granularity` (string): 'daily', 'weekly', 'monthly'

#### 4.2.3 analyze_budget_performance

**目的**: 予算vs実績分析
**パラメータ**:

- `period` (string): 分析期間
- `category` (string, optional): 特定カテゴリー

#### 4.2.4 detect_anomalies

**目的**: 支出異常の検知
**パラメータ**:

- `sensitivity` (string): 'low', 'medium', 'high'
- `period` (string): 分析対象期間

### 4.3 レポートツール

#### 4.3.1 generate_monthly_report

**目的**: 月次レポート生成
**パラメータ**:

- `year` (number): 対象年
- `month` (number): 対象月
- `format` (string): 'summary', 'detailed'

#### 4.3.2 generate_yearly_summary

**目的**: 年次サマリー生成
**パラメータ**:

- `year` (number): 対象年

#### 4.3.3 export_data

**目的**: データエクスポート
**パラメータ**:

- `format` (string): 'csv', 'json', 'excel'
- `start_date` (string, optional): 開始日
- `end_date` (string, optional): 終了日

### 4.4 設定・管理ツール

#### 4.4.1 manage_categories

**目的**: カテゴリー管理
**パラメータ**:

- `action` (string): 'add', 'update', 'delete', 'list'
- `category_name` (string): カテゴリー名
- `category_type` (string): 'income' または 'expense'
- `parent_category` (string, optional): 親カテゴリー

#### 4.4.2 manage_accounts

**目的**: アカウント管理
**パラメータ**:

- `action` (string): 'add', 'update', 'delete', 'list'
- `account_name` (string): アカウント名
- `account_type` (string): 'bank', 'credit', 'cash', 'investment'
- `initial_balance` (number, optional): 初期残高

#### 4.4.3 manage_budgets

**目的**: 予算管理
**パラメータ**:

- `action` (string): 'add', 'update', 'delete', 'list'
- `category` (string): 対象カテゴリー
- `amount` (number): 予算額
- `period_type` (string): 'monthly', 'yearly'

## 5. 会話シナリオ例

### 5.1 基本的な質問

**ユーザー**: "今月の支出はいくら？"
**システム**: 今月（2025年7月）の総支出は¥45,230です。主な内訳は食費が¥18,500、交通費が¥8,200、光熱費が¥7,800となっています。

### 5.2 比較分析

**ユーザー**: "先月と比べて今月の食費はどう？"
**システム**: 今月の食費は¥18,500で、先月の¥16,200と比較して¥2,300（14.2%）増加しています。主に外食費が増えている傾向があります。

### 5.3 異常検知

**ユーザー**: "何か普段と違う支出はある？"
**システム**: 7月15日の「雑費」カテゴリーで¥25,000の支出が通常の5倍程度高くなっています。これは異常な支出パターンの可能性があります。

### 5.4 予算管理

**ユーザー**: "今月の予算達成状況は？"
**システム**: 7月の予算進捗状況：

- 食費: 92% (¥18,500/¥20,000)
- 交通費: 68% (¥8,200/¥12,000)
- 娯楽費: 125% (¥15,000/¥12,000) ⚠️予算超過

## 6. 技術スタック

### 6.1 開発環境

- **言語**: Python 3.11+
- **フレームワーク**: FastAPI (MCPサーバー)
- **データベース**: SQLite (開発), PostgreSQL (本番)
- **データ分析**: pandas, numpy, scipy
- **可視化**: matplotlib, plotly
- **テスト**: pytest, pytest-asyncio

### 6.2 依存ライブラリ

```python
# requirements.txt
fastapi==0.104.1
uvicorn==0.24.0
sqlite3  # 標準ライブラリ
pandas==2.1.3
numpy==1.25.2
matplotlib==3.8.2
plotly==5.17.0
pydantic==2.5.0
python-dateutil==2.8.2
pytest==7.4.3
pytest-asyncio==0.21.1
```

## 7. 開発計画

### 7.1 フェーズ1: 基盤構築 (Week 1-2)

- [ ] プロジェクト構造作成
- [ ] データベーススキーマ実装
- [ ] 基本的なMCPサーバー構築
- [ ] 基本的なCRUD操作

### 7.2 フェーズ2: 核心機能 (Week 3-4)

- [ ] 取引データ管理機能
- [ ] 基本的な分析機能
- [ ] カテゴリー・アカウント管理

### 7.3 フェーズ3: 分析機能拡張 (Week 5-6)

- [ ] トレンド分析
- [ ] 予算管理機能
- [ ] 異常検知アルゴリズム

### 7.4 フェーズ4: UI/UX改善 (Week 7-8)

- [ ] グラフ・チャート生成
- [ ] レポート機能
- [ ] エクスポート機能

### 7.5 フェーズ5: 品質向上 (Week 9-10)

- [ ] テストカバレッジ向上
- [ ] パフォーマンス最適化
- [ ] ドキュメント整備

## 8. テスト戦略

### 8.1 単体テスト

- データベース操作のテスト
- 分析アルゴリズムのテスト
- MCPツール個別機能のテスト

### 8.2 統合テスト

- MCPサーバー全体のフローテスト
- データの整合性テスト

### 8.3 パフォーマンステスト

- 大量データでの応答時間測定
- メモリ使用量の監視

## 9. セキュリティ考慮事項

### 9.1 データ保護

- 個人財務データの暗号化
- バックアップデータの保護
- ログ出力時の機密情報マスキング

### 9.2 アクセス制御

- 認証機能の実装
- 操作権限の管理

## 10. 運用・保守

### 10.1 監視

- エラーログの監視
- パフォーマンスメトリクスの追跡

### 10.2 バックアップ

- 定期的なデータバックアップ
- 災害復旧計画

## 11. 今後の拡張計画

### 11.1 機能拡張

- 複数通貨対応
- 投資ポートフォリオ分析
- 税務レポート機能

### 11.2 統合

- 銀行API連携
- 家計簿アプリとの連携
- クラウドストレージ統合

---

**作成日**: 2025年7月29日  
**バージョン**: 1.0  
**作成者**: プロジェクトチーム
