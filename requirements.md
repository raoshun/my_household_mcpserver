# Household Budget Analysis MCP Server - 要件定義（requirements.md）

- バージョン: v1.0
- 日付: 2025-10-12
- 作成者: GitHub Copilot
- 対象: 個人/世帯向け 家計分析用 MCP サーバ
- 言語: 日本語（優先）
- ステータス: 承認済み（Q1〜Q10反映）

## 1. 概要

本システムは、ローカル環境で家計データを安全に取り扱い、自然言語（日本語）での対話を通じて収支の可視化・分析・予算管理を行う MCP（Model Context Protocol）サーバです。プライバシーファーストを重視し、原則ローカル処理・ローカル保存とします。

## 2. 範囲

- 含む: 取引データの取り込み・正規化・分析・対話的な質問応答・予算差異の可視化・レポート出力
- 含まない（初期版v1では除外/将来検討）:
  - OFX/QIF/TSVの取り込み
  - マルチプロフィール
  - バックアップ/復元
  - 監査ログ（詳細な監査・保持ポリシー）
  - 異常値検出

## 3. 用語

- 取引: 日付、金額、摘要、カテゴリ等を持つ家計記録
- 世帯: 単一または複数のメンバーで構成される家計単位
- MCPツール: MCPクライアントから呼び出される分析/操作インターフェース

## 4. 前提・制約

- すべての処理・保存は原則ローカル（オフライン動作前提）
- 日本円（JPY）のみを対象（多通貨は対象外）
- 入出力ファイルはローカルパス指定（入力はCSV）
- 個人情報は外部送信しない（ユーザーが明示的に許可しない限り）
- データ保存場所は data/ ディレクトリ配下

## 5. 機能要件（FR）

FR-001 取引データ取り込み

- ユーザーは CSV（カンマ区切り）のファイルから取引を取り込める
- 列マッピングをユーザーが指定・保存できる（テンプレート）
- 受入時にエンコーディングと日付形式を指定可能
- 受入時に重複判定を行う
受け入れ条件:
- サンプルCSVで1000件以上を正しく取り込める
- 列マッピングテンプレートを保存/再利用できる
- 重複が二重登録されない

FR-002 取引の正規化/検証

- 符号（支出はマイナス/プラスの取り扱い）と小数/通貨を正規化
- 日付/金額/必須フィールドの検証とエラー報告
受け入れ条件:
- 不正行は行番号と理由付きでレポートされる
- 正規化後の件数/合計が期待値と一致

FR-003 自動分類と手動上書き

- システムは取引をカテゴリへ自動分類（MoneyForward形式のカテゴリ/サブカテゴリ体系を採用）
- ユーザーは手動でカテゴリ修正・ルール追加が可能（優先）
受け入れ条件:
- 学習/ルール更新後、再分類で上書きが反映
- 自動分類精度の簡易レポートが取得可能（正解率、未分類率）

FR-004 対話的質問応答（MCP）

- 日本語で「先月の食費は？」「今期の固定費の内訳は？」等に回答
- フォローアップ（文脈）対応
受け入れ条件:
- 代表的質問10種に対し、数値/期間/カテゴリが正確
- コンテキストを跨ぐ2往復以上で意味整合が保たれる

FR-005 集計・分析

- 期間別/カテゴリ別/店舗（摘要）別/口座別の集計
- 月次トレンド、トップN支出
受け入れ条件:
- 指定期間・粒度（日/週/月/年）で数値が正しい

FR-006 予算管理

- サブカテゴリ別の月次予算の設定/編集/インポート
- 期首は月初（毎月1日）固定
- 実績との差異・達成率・警告（しきい値）提示
受け入れ条件:
- 達成率と差異が正しく計算・表示
- しきい値超過で警告フラグが返る

FR-007 レポート出力

- 集計結果をCSV/JSONとしてエクスポート
- レポートに期間・条件のメタ情報を付与
受け入れ条件:
- 指定ディレクトリに正しい形式・エンコーディングで保存

FR-008 タグ/メモ付与

- 取引に任意タグ・メモを付与・検索可能
受け入れ条件:
- タグでのフィルタと複合条件検索が機能

FR-009 重複検出・解決(拡張版)

FR-009-1 重複検出ロジック

- 日付と金額に基づく重複候補の検出
- 日付の誤差許容オプション（±N日、デフォルト: 0日=完全一致）
- 金額の誤差許容オプション:
  - 絶対値での誤差（±X円、デフォルト: 0円=完全一致）
  - 割合での誤差（±Y%、デフォルト: 0%=完全一致）
- 検出された重複候補ペアのリスト生成
- 摘要・カテゴリは重複判定基準に含めない(ユーザーの最終判断材料として提示のみ)

FR-009-2 ユーザー確認インターフェース(必須)

- 重複候補をMCPツール経由でユーザーに提示
- 各候補ペアの詳細情報を並べて表示:
  - 取引ID、日付、金額、摘要、カテゴリ、口座、メモ等
- ユーザーが各ペアに対して判定を入力:
  - 「重複である」/ 「重複でない」/ 「スキップ（保留）」
- 判定結果を取引レコードに記録

FR-009-3 データベースキャッシュと判定結果の永続化

- CSVから読み込んだ取引データをSQLiteデータベースにキャッシュ
- データベース配置場所: `data/household.db`
- 各取引レコードに以下のフィールドを追加:
  - `is_duplicate`: Boolean（重複フラグ、デフォルト: False）
  - `duplicate_of`: 参照先取引ID（どの取引の重複か）
  - `duplicate_checked`: Boolean（ユーザーが確認済みか）
  - `duplicate_checked_at`: タイムスタンプ（確認日時）
- ユーザーの判定結果をDBに保存し、以降の分析・レポートで活用

FR-009-4 重複解消アクション

- ユーザーが「重複である」と確認した取引に対して:
  - `is_duplicate=True`フラグを設定（論理削除）
  - 元データは保持（物理削除しない）
  - 重複フラグが立った取引は、デフォルトで集計・分析から除外
  - オプションで重複取引を含めた分析も可能（監査・検証用）
- 誤判定した場合の復元機能:
  - フラグをFalseに戻すことで復元可能
- 処理履歴をDBに記録(誰が、いつ、どの取引を重複と判定したか)

受け入れ条件:

- 同一ファイル再取り込みで、誤差オプション=0の場合に件数が増えない
- 誤差オプション指定時、指定範囲内の類似取引が重複候補として検出される
- ユーザーが重複候補を確認し、判定を記録できる
- 判定結果がDBに永続化され、再起動後も保持される
- 重複フラグが立った取引は、デフォルトの集計から除外される
- 重複フラグの解除（復元）が可能

FR-010 マルチプロフィール（将来）

- v1では非対応（単一プロファイル前提）
受け入れ条件:
- なし（将来対応時に定義）

FR-011 MCPツール群

- データ取り込み、クエリ集計、予算操作、レポート出力をツールとして公開
- 入力検証とエラーを日本語で返す
受け入れ条件:
- 主要操作が全てMCP経由で実行可能

FR-012 監査/ログ（将来）

- v1では不要（既定無効）。必要時に有効化できる設計とする（設計以降で方針化）
受け入れ条件:
- なし（将来対応時に定義）

FR-013 バックアップ/復元（将来）

- v1では提供しない
受け入れ条件:
- なし（将来対応時に定義）

FR-014 エラー/メッセージの日本語化

- すべてのユーザ向けメッセージは日本語で表示/返却
受け入れ条件:
- 代表エラーケースで自然な日本語が返る

## 6. 非機能要件（NFR）

NFR-001 プライバシー: 既定で外部通信なし。明示許可時のみ外部送信
NFR-002 パフォーマンス: 取引10万件で主要クエリが2秒以内（ローカルSSD想定）
NFR-003 可用性: 単体ローカル運用で安定。異常終了時の再起動で整合性保持
NFR-004 セキュリティ: 保存データの暗号化はなし（v1）。OSユーザ権限で保護
NFR-005 移植性: Linuxのみで動作（x86_64/ARM64は環境に依存）
NFR-006 国際化: 日本語優先。通貨はJPY固定
NFR-007 保守性: 設定/データ/コードを分離。設定は人間可読（YAML/JSON）
NFR-008 監視性: v1では対象外（将来）
NFR-009 テスト性: サンプルデータセット/固定シナリオで再現可能
NFR-010 信頼性: 取り込み時のトランザクション性(部分失敗のロールバック/スキップ)
NFR-011 データ永続性: 重複判定結果はSQLiteで永続化。再起動後も保持

## 7. 受け入れテストシナリオ（抜粋）

TS-001 CSV取り込み正常系: マッピング適用→1000件登録→合計一致
TS-002 取り込み異常系: 不正日付/金額→行番号と理由を報告
TS-003 重複防止: 同一ファイル再取込→総件数不変
TS-003-1 重複検出(誤差なし): 日付・金額完全一致の取引ペアが検出される
TS-003-2 重複検出(日付誤差): ±1日、金額完全一致で候補検出
TS-003-3 重複検出(金額誤差): 日付完全一致、金額±10円または±1%で候補検出
TS-003-4 ユーザー確認: 重複候補の詳細表示→判定入力→DB保存
TS-003-5 重複フラグ: 重複と判定された取引が集計から除外される
TS-003-6 復元機能: 誤判定をフラグ解除で復元→集計に再度含まれる
TS-004 自動分類後の上書き: 手動修正→再分類→修正保持
TS-005 代表質問応答: 「先月の食費/固定費/収入合計/トップ3支出」回答の正確性
TS-006 予算差異: 予算設定→月次集計→差異/警告の一致
TS-007 レポート出力: 条件付CSV出力→内容とメタ一致
TS-008 バックアップ/復元: v1では対象外（将来）
TS-009 ローカル限定: ネットワーク遮断でも機能動作
TS-010 日本語エラーメッセージ: 代表エラーで自然な日本語

## 8. エッジケース/例外

- 文字コード混在（UTF-8, Shift_JIS）
- 日付形式混在（YYYY/MM/DD, DD-MM-YYYY）
- 返金/払い戻し（負金額）、ゼロ金額
- 摘要のノイズ/絵文字/長文
- タイムゾーン跨ぎ月末処理
- 口座間振替（実質収支0）
- - 重複だが微差(メモのみ差異)
- 同日同額の複数取引(実際には別物、例:同じ店で朝夜に買い物)
- 多通貨・為替換算（v1対象外）
- 非常に大きい単発支出（異常値扱い）

## 9. 成功基準

- 代表シナリオ（TS-001〜TS-010）を再現可能
- 10万件規模で実用応答
- ローカルのみで一連の運用が完結

## 10. トレーサビリティ

- FRとTSを相互参照（例: FR-001 ↔ TS-001/002/003）

## 11. 決定事項（Q1〜Q10反映）

- Q1: 入力はCSVを優先（v1はCSVのみ対応）
- Q2: 通貨はJPYのみ
- Q3: プロファイルは単一想定（マルチは将来）
- Q4: カテゴリ体系はMoneyForward形式を採用
- Q5: 予算はサブカテゴリ粒度、期首は月初固定
- Q6: MCPクライアントはテキスト対話のみでOK
- Q7: 保存場所は data/、バックアップなし、暗号化なし
- Q8: ログ保持は不要（監査ログは将来）
- Q9: 異常値検出は現時点で検討不要（将来）
- Q10: 対応OSはLinuxのみ

## 12. 承認

- 本要件は承認済み。設計（design.md）へ進みます。
