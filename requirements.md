# Requirements Specification: Trend Analysis Feature

- **Version:** 0.1.0
- **Date:** 2025-10-02
- **Author:** GitHub Copilot (AI assistant)
- **Status:** Draft (pending approval)

## Overview

家計簿分析MCPサーバーにおいて、FP相談レベルの洞察を支援するため、直近12か月の支出データを用いたトレンド分析機能を追加する。利用者は自然言語で質問し、カテゴリ別の月次推移と主要指標を理解できる。

## Scope

- 対象データ: ローカルに保存された家計簿CSV（カテゴリ階層: 大項目/中項目）
- 対象期間: 直近12か月の月次データ
- 対象指標: 金額、前月比、12か月平均、前年同月比
- ユーザーインターフェース: MCPプロトコル経由のテキスト応答

## Assumptions

1. 直近12か月分の家計簿CSVファイルが存在し、フォーマットは既存データに準拠する。
2. 「大項目」「中項目」列が存在し、カテゴリ分析に利用できる。
3. 年月はファイル名または日付列から判定できる。
4. MCPクライアントが自然言語の質問を構造化クエリに変換できる。
5. 数値出力は円単位、小数第1位での丸めが許容される。

## Functional Requirements

### FR-001: 月次カテゴリ推移指標の生成

**Description:** 直近12か月のデータからカテゴリ（大項目）別に支出金額を集計し、月次推移と主要指標（前月比、12か月平均、前年同月比）を算出する。

**Acceptance Criteria:**

1. 各カテゴリについて12か月分のレコードが生成され、金額・前月比・12か月平均・前年同月比が含まれる。
2. 前年同月のデータが存在しない月は `"前年比": "N/A"` など明示的な値で示される。
3. 月次推移は年月順に整列される。

**Test Scenarios:**

- TS-001: 完全な12か月データを入力した際、各カテゴリの指標が期待通り算出される。
- TS-002: 初月に前年同月データがない場合、前年比が "N/A" になる。
- TS-003: 特定カテゴリのデータが欠落している月に対し、0円として扱う（または欠損処理ポリシーどおりになる）。

### FR-002: 自然言語質問への回答生成

**Description:** ユーザーが「○月と○月の△△カテゴリの増減を教えて」など自然言語で質問した際、該当月とカテゴリを解釈し、指標値を含むテキスト応答を生成する。

**Acceptance Criteria:**

1. 質問に含まれる年月とカテゴリを正しく抽出し、計算結果をテキストで返す。
2. 応答文には対象期間、カテゴリ名、金額、前月比/前年比等の指標が含まれる。
3. 対象データが存在しない場合は、その旨を説明するメッセージを返す。

**Test Scenarios:**

- TS-004: 「2025年6月と7月の食費の増減を教えて」の質問に対し、差額と変化率を説明する文が返る。
- TS-005: データ期間外の年月を指定した質問に対して「データが不足しています」と通知する。
- TS-006: カテゴリが指定されない質問に対し、全カテゴリのサマリを返す。

### FR-003: データ期間とカテゴリ抽出の制御

**Description:** 直近12か月のデータ範囲を自動判定し、対象カテゴリ一覧を抽出した上で分析に利用する。カテゴリ未指定時には支出上位カテゴリの要約を返す。

**Acceptance Criteria:**

1. 実在するデータファイルから最新年月を特定し、12か月分を範囲として確定する。
2. カテゴリ未指定の場合、支出額上位3カテゴリ（デフォルト）を要約する。
3. 指定カテゴリが存在しない場合、説明文付きで応答する。

**Test Scenarios:**

- TS-007: 最新ファイルが2025年8月の場合、2024年9月〜2025年8月の範囲で分析する。
- TS-008: カテゴリ未指定質問に対し、上位カテゴリの金額と変化率が列挙される。
- TS-009: 存在しないカテゴリを指定した場合に「該当カテゴリが見つかりません」と返す。

## Non-Functional Requirements

### NFR-001: 応答表現

- MCPサーバーはテキストベースで回答し、数値は `12,345円` のように桁区切り表示、小数は1桁まで。
- 指標値は括弧内に補足説明（例: `前月比 +5.2%`）。

### NFR-002: パフォーマンス

- 12か月分の分析処理は1秒以内（目標値）。
- 同時リクエストは最大3件程度まで想定。

### NFR-003: 信頼性・エラーハンドリング

- 欠損データやゼロ除算などの異常値は安全に処理し、ユーザーに説明する。
- ファイル読み込み失敗時はリトライせずエラーメッセージを返す。

### NFR-004: セキュリティ・プライバシー

- すべての計算はローカル環境で完結。
- 個人情報が含まれるフィールドを外部に送信しない。

## Open Questions

- 自然言語解析ロジックをサーバー側で持つか、クライアント（LLM）から構造化クエリを受け取るか。
- 欠損値処理ポリシー（0円扱い・除外・表示）をどこまで自動化するか。

## Approval

- **Pending:** Please review and confirm before moving to design.md stage.
