# Requirements Specification: Trend Analysis Feature

- **Version:** 0.1.0
- **Date:** 2025-10-02
- **Author:** GitHub Copilot (AI assistant)
- **Status:** Draft (pending approval)

## Overview

家計簿分析MCPサーバーにおいて、FP相談レベルの洞察を支援するため、直近12か月の支出データを用いたトレンド分析機能を追加する。利用者は自然言語で質問し、カテゴリ別の月次推移と主要指標を理解できる。

## Scope

- 対象データ: ローカルに保存された家計簿CSV（カテゴリ階層: 大項目/中項目）
- 対象期間: 直近12か月の月次データ
- 対象指標: 金額、前月比、12か月平均、前年同月比
- ユーザーインターフェース: MCPプロトコル経由のテキスト応答

## Assumptions

1. 直近12か月分の家計簿CSVファイルが存在し、フォーマットは既存データに準拠する。
2. 「大項目」「中項目」列が存在し、カテゴリ分析に利用できる。
3. 年月はファイル名または日付列から判定できる。
4. MCPクライアントが自然言語の質問を構造化クエリに変換できる。
5. 数値出力は円単位、小数第1位での丸めが許容される。

## Functional Requirements

### FR-001: 月次カテゴリ推移指標の生成

**Description:** 直近12か月のデータからカテゴリ（大項目）別に支出金額を集計し、月次推移と主要指標（前月比、12か月平均、前年同月比）を算出する。

**Acceptance Criteria:**

1. 各カテゴリについて12か月分のレコードが生成され、金額・前月比・12か月平均・前年同月比が含まれる。
2. 前年同月のデータが存在しない月は `"前年比": "N/A"` など明示的な値で示される。
3. 月次推移は年月順に整列される。

**Test Scenarios:**

- TS-001: 完全な12か月データを入力した際、各カテゴリの指標が期待通り算出される。
- TS-002: 初月に前年同月データがない場合、前年比が "N/A" になる。
- TS-003: 特定カテゴリのデータが欠落している月に対し、0円として扱う（または欠損処理ポリシーどおりになる）。

### FR-002: 自然言語質問への回答生成

**Description:** ユーザーが「○月と○月の△△カテゴリの増減を教えて」など自然言語で質問した際、該当月とカテゴリを解釈し、指標値を含むテキスト応答を生成する。

**Acceptance Criteria:**

1. 質問に含まれる年月とカテゴリを正しく抽出し、計算結果をテキストで返す。
2. 応答文には対象期間、カテゴリ名、金額、前月比/前年比等の指標が含まれる。
3. 対象データが存在しない場合は、その旨を説明するメッセージを返す。

**Test Scenarios:**

- TS-004: 「2025年6月と7月の食費の増減を教えて」の質問に対し、差額と変化率を説明する文が返る。
- TS-005: データ期間外の年月を指定した質問に対して「データが不足しています」と通知する。
- TS-006: カテゴリが指定されない質問に対し、全カテゴリのサマリを返す。

### FR-003: データ期間とカテゴリ抽出の制御

**Description:** 直近12か月のデータ範囲を自動判定し、対象カテゴリ一覧を抽出した上で分析に利用する。カテゴリ未指定時には支出上位カテゴリの要約を返す。

**Acceptance Criteria:**

1. 実在するデータファイルから最新年月を特定し、12か月分を範囲として確定する。
2. カテゴリ未指定の場合、支出額上位3カテゴリ（デフォルト）を要約する。
3. 指定カテゴリが存在しない場合、説明文付きで応答する。

**Test Scenarios:**

- TS-007: 最新ファイルが2025年8月の場合、2024年9月〜2025年8月の範囲で分析する。
- TS-008: カテゴリ未指定質問に対し、上位カテゴリの金額と変化率が列挙される。
- TS-009: 存在しないカテゴリを指定した場合に「該当カテゴリが見つかりません」と返す。

## Non-Functional Requirements

### NFR-001: 応答表現

- MCPサーバーはテキストベースで回答し、数値は `12,345円` のように桁区切り表示、小数は1桁まで。
- 指標値は括弧内に補足説明（例: `前月比 +5.2%`）。

### NFR-002: パフォーマンス

- 12か月分の分析処理は1秒以内（目標値）。
- 同時リクエストは最大3件程度まで想定。

### NFR-003: 信頼性・エラーハンドリング

- 欠損データやゼロ除算などの異常値は安全に処理し、ユーザーに説明する。
- ファイル読み込み失敗時はリトライせずエラーメッセージを返す。

### NFR-004: セキュリティ・プライバシー

- すべての計算はローカル環境で完結。
- 個人情報が含まれるフィールドを外部に送信しない。

### FR-004: グラフ画像生成機能

**Description:** 既存のMCPツール（`get_monthly_household`, `get_category_trend`）に画像出力オプションを追加し、家計簿データを視覚化したグラフ画像を生成する。

**Acceptance Criteria:**

1. 各MCPツールに `output_format` パラメータを追加し、`"text"` または `"image"` を選択可能とする。
2. `output_format="image"` 指定時、適切なグラフタイプで画像を生成する：
   - `get_monthly_household`: 月次支出の棒グラフまたは円グラフ
   - `get_category_trend`: カテゴリ別推移の線グラフまたは棒グラフ
3. 生成された画像は標準的な形式（PNG、SVG等）で出力される。
4. グラフには適切なタイトル、軸ラベル、凡例が含まれる。

**Test Scenarios:**

- TS-010: `get_monthly_household(year=2025, month=8, output_format="image")` でその月の支出構成円グラフが生成される。
- TS-011: `get_category_trend(category="食費", output_format="image")` で食費の12か月推移線グラフが生成される。
- TS-012: `output_format="text"` 指定時は従来通りのテキスト応答が返される。

### FR-005: Streamable HTTP画像配信機能

**Description:** 生成されたグラフ画像データをHTTPストリーミング経由で効率的に配信し、MCPクライアントが画像を受信・表示できるようにする。

**Acceptance Criteria:**

1. MCPサーバーにHTTPエンドポイントを追加し、画像データのストリーミング配信に対応する。
2. 大容量画像データを分割して送信し、クライアント側での段階的な読み込みを可能にする。
3. 画像形式に応じた適切なContent-Typeヘッダーを設定する。
4. ストリーミング中のエラー処理とリトライ機能を提供する。

**Test Scenarios:**

- TS-013: 生成された画像が複数のチャンクに分割されて正常に送信される。
- TS-014: ネットワーク中断時にクライアント側でリトライが可能な仕組みで配信される。
- TS-015: 異なる画像形式（PNG、SVG等）で適切なヘッダーが設定される。

### FR-006: MCPツール引数拡張

**Description:** 既存のMCPツール `get_monthly_household` と `get_category_trend` に、グラフ出力制御のための引数を追加する。

**Acceptance Criteria:**

1. `output_format` 引数を追加：`"text"`（デフォルト）または `"image"` を指定可能。
2. `graph_type` 引数を追加：画像出力時のグラフタイプを指定（`"bar"`, `"line"`, `"pie"` 等）。
3. `image_size` 引数を追加：出力画像のサイズを指定（例：`"800x600"`）。
4. 後方互換性を維持し、既存の呼び出し方法では従来通りテキスト出力する。

**Test Scenarios:**

- TS-016: 引数なしの呼び出しで従来通りのテキスト応答が返される。
- TS-017: `output_format="image", graph_type="pie"` で円グラフが生成される。
- TS-018: 無効な引数値に対して適切なエラーメッセージが返される。

## Non-Functional Requirements（追加）

### NFR-005: 画像生成パフォーマンス

- グラフ画像生成は3秒以内に完了する（12か月分データ、標準サイズ）。
- 生成された画像のメモリ使用量は50MB以下とする。

### NFR-006: HTTP ストリーミング性能

- 画像データのストリーミング配信は1MB/秒以上の転送速度を維持する。
- 同時ストリーミング接続は最大5件まで対応する。

### NFR-007: 画像品質・形式

- 生成されるグラフは視認性の高い配色とフォントサイズを使用する。
- 複数の画像形式（PNG、SVG）に対応し、用途に応じて選択可能とする。
- 日本語ラベルの文字化けを防止する。

### NFR-008: MCPクライアント互換性

- MCPプロトコル仕様に準拠し、既存クライアントとの互換性を維持する。
- 新機能は段階的に有効化でき、クライアント側の対応が不完全でも基本機能は利用可能とする。

## Open Questions

1. **グラフライブラリの選択**: matplotlib、plotly、Chart.js等、どのライブラリを使用するかの技術選択
2. **画像キャッシュ**: 同じ条件で生成された画像のキャッシュ戦略
3. **エラー処理**: 画像生成失敗時のフォールバック動作（テキスト出力への切り替え等）
4. **セキュリティ**: HTTP配信時のアクセス制御や認証の必要性

## Dependencies

- **画像生成ライブラリ**: matplotlib, pillow, または類似ライブラリ
- **HTTP ストリーミング**: FastAPI, aiohttp, または類似フレームワーク
- **既存MCP実装**: 現在の `get_monthly_household`, `get_category_trend` ツール

## Constraints

1. 既存のMCPツール呼び出し方法との後方互換性を維持する
2. ローカル実行環境での動作を前提とし、外部サービス依存を避ける
3. 生成される画像データは一時的なものとし、永続化は必須要件としない

- 自然言語解析ロジックをサーバー側で持つか、クライアント（LLM）から構造化クエリを受け取るか。
- 欠損値処理ポリシー（0円扱い・除外・表示）をどこまで自動化するか。

## Approval

- **Pending:** Please review and confirm before moving to design.md stage.
