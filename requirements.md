# Household Budget Analysis MCP Server - 要件定義（requirements.md）

- バージョン: v1.5（フェーズ 15: 高度な分析機能）
- 日付: 2025-11-08
- 作成者: GitHub Copilot
- 対象: 個人/世帯向け 家計分析用 MCP サーバ
- 言語: 日本語（優先）
- ステータス: 承認済み（FR-001〜FR-024） + 計画中（FR-025〜FR-030）
- **Phase 14 状況**: ✅ 完了（2025-11-08）
  - テスト: 48/48 PASSED (100%)
  - カバレッジ: 76% (report_tools)
  - パフォーマンス: < 500ms ✅

## 1. 概要

本システムは、ローカル環境で家計データを安全に取り扱い、自然言語（日本語）での対話を通じて収支の可視化・分析・予算管理を行う MCP（Model Context Protocol）サーバです。プライバシーファーストを重視し、原則ローカル処理・ローカル保存とします。

## 2. 範囲

- 含む: 取引データの取り込み・正規化・分析・対話的な質問応答・予算差異の可視化・レポート出力
- 含まない（初期版v1では除外/将来検討）:
  - OFX/QIF/TSVの取り込み
  - マルチプロフィール
  - バックアップ/復元
  - 監査ログ（詳細な監査・保持ポリシー）
  - 異常値検出

## 3. 用語

- 取引: 日付、金額、摘要、カテゴリ等を持つ家計記録
- 世帯: 単一または複数のメンバーで構成される家計単位
- MCPツール: MCPクライアントから呼び出される分析/操作インターフェース

## 4. 前提・制約

- すべての処理・保存は原則ローカル（オフライン動作前提）
- 日本円（JPY）のみを対象（多通貨は対象外）
- 入出力ファイルはローカルパス指定（入力はCSV）
- 個人情報は外部送信しない（ユーザーが明示的に許可しない限り）
- データ保存場所は data/ ディレクトリ配下

## 5. 機能要件（FR）

FR-001 取引データ取り込み

- ユーザーは CSV（カンマ区切り）のファイルから取引を取り込める
- 列マッピングをユーザーが指定・保存できる（テンプレート）
- 受入時にエンコーディングと日付形式を指定可能
- 受入時に重複判定を行う
受け入れ条件:
- サンプルCSVで1000件以上を正しく取り込める
- 列マッピングテンプレートを保存/再利用できる
- 重複が二重登録されない

FR-002 取引の正規化/検証

- 符号（支出はマイナス/プラスの取り扱い）と小数/通貨を正規化
- 日付/金額/必須フィールドの検証とエラー報告
受け入れ条件:
- 不正行は行番号と理由付きでレポートされる
- 正規化後の件数/合計が期待値と一致

FR-003 自動分類と手動上書き

- システムは取引をカテゴリへ自動分類（MoneyForward形式のカテゴリ/サブカテゴリ体系を採用）
- ユーザーは手動でカテゴリ修正・ルール追加が可能（優先）
受け入れ条件:
- 学習/ルール更新後、再分類で上書きが反映
- 自動分類精度の簡易レポートが取得可能（正解率、未分類率）

FR-004 対話的質問応答（MCP）

- 日本語で「先月の食費は？」「今期の固定費の内訳は？」等に回答
- フォローアップ（文脈）対応
受け入れ条件:
- 代表的質問10種に対し、数値/期間/カテゴリが正確
- コンテキストを跨ぐ2往復以上で意味整合が保たれる

FR-005 集計・分析

- 期間別/カテゴリ別/店舗（摘要）別/口座別の集計
- 月次トレンド、トップN支出
受け入れ条件:
- 指定期間・粒度（日/週/月/年）で数値が正しい

FR-006 予算管理

- サブカテゴリ別の月次予算の設定/編集/インポート
- 期首は月初（毎月1日）固定
- 実績との差異・達成率・警告（しきい値）提示
受け入れ条件:
- 達成率と差異が正しく計算・表示
- しきい値超過で警告フラグが返る

FR-007 レポート出力

- 集計結果をCSV/JSONとしてエクスポート
- レポートに期間・条件のメタ情報を付与
受け入れ条件:
- 指定ディレクトリに正しい形式・エンコーディングで保存

FR-008 タグ/メモ付与

- 取引に任意タグ・メモを付与・検索可能
受け入れ条件:
- タグでのフィルタと複合条件検索が機能

FR-009 重複検出・解決(拡張版)

FR-009-1 重複検出ロジック

- 日付と金額に基づく重複候補の検出
- 日付の誤差許容オプション（±N日、デフォルト: 0日=完全一致）
- 金額の誤差許容オプション:
  - 絶対値での誤差（±X円、デフォルト: 0円=完全一致）
  - 割合での誤差（±Y%、デフォルト: 0%=完全一致）
- 検出された重複候補ペアのリスト生成
- 摘要・カテゴリは重複判定基準に含めない(ユーザーの最終判断材料として提示のみ)

FR-009-2 ユーザー確認インターフェース(必須)

- 重複候補をMCPツール経由でユーザーに提示
- 各候補ペアの詳細情報を並べて表示:
  - 取引ID、日付、金額、摘要、カテゴリ、口座、メモ等
- ユーザーが各ペアに対して判定を入力:
  - 「重複である」/ 「重複でない」/ 「スキップ（保留）」
- 判定結果を取引レコードに記録

FR-009-3 データベースキャッシュと判定結果の永続化

- CSVから読み込んだ取引データをSQLiteデータベースにキャッシュ
- データベース配置場所: `data/household.db`
- 各取引レコードに以下のフィールドを追加:
  - `is_duplicate`: Boolean（重複フラグ、デフォルト: False）
  - `duplicate_of`: 参照先取引ID（どの取引の重複か）
  - `duplicate_checked`: Boolean（ユーザーが確認済みか）
  - `duplicate_checked_at`: タイムスタンプ（確認日時）
- ユーザーの判定結果をDBに保存し、以降の分析・レポートで活用

FR-009-4 重複解消アクション

- ユーザーが「重複である」と確認した取引に対して:
  - `is_duplicate=True`フラグを設定（論理削除）
  - 元データは保持（物理削除しない）
  - 重複フラグが立った取引は、デフォルトで集計・分析から除外
  - オプションで重複取引を含めた分析も可能（監査・検証用）
- 誤判定した場合の復元機能:
  - フラグをFalseに戻すことで復元可能
- 処理履歴をDBに記録(誰が、いつ、どの取引を重複と判定したか)

受け入れ条件:

- 同一ファイル再取り込みで、誤差オプション=0の場合に件数が増えない
- 誤差オプション指定時、指定範囲内の類似取引が重複候補として検出される
- ユーザーが重複候補を確認し、判定を記録できる
- 判定結果がDBに永続化され、再起動後も保持される
- 重複フラグが立った取引は、デフォルトの集計から除外される
- 重複フラグの解除（復元）が可能

FR-010 マルチプロフィール（将来）

- v1では非対応（単一プロファイル前提）
受け入れ条件:
- なし（将来対応時に定義）

FR-011 MCPツール群

- データ取り込み、クエリ集計、予算操作、レポート出力をツールとして公開
- 入力検証とエラーを日本語で返す
受け入れ条件:
- 主要操作が全てMCP経由で実行可能

FR-012 監査/ログ（将来）

- v1では不要（既定無効）。必要時に有効化できる設計とする（設計以降で方針化）
受け入れ条件:
- なし（将来対応時に定義）

FR-013 バックアップ/復元（将来）

- v1では提供しない
受け入れ条件:
- なし（将来対応時に定義）

FR-014 エラー/メッセージの日本語化

- すべてのユーザ向けメッセージは日本語で表示/返却
受け入れ条件:
- 代表エラーケースで自然な日本語が返る

FR-015 グラフ可視化機能

- 家計データをグラフ画像として生成・表示できる
- サポートするグラフタイプ:
  - 円グラフ（pie）: カテゴリ別支出割合
  - 棒グラフ（bar）: カテゴリ間比較
  - 折れ線グラフ（line）: 時系列トレンド
  - 面グラフ（area）: 累積トレンド
- 日本語テキスト（カテゴリ名、ラベル等）を正しくレンダリング
- 画像サイズの指定が可能（デフォルト: 800x600）
- 画像フォーマットの指定が可能（png, svg, jpg）
受け入れ条件:
- 全グラフタイプで日本語が正しく表示される
- MCPツール経由で画像URLまたは画像データが取得できる
- 指定した画像サイズ・フォーマットで出力される

FR-016 HTTP画像配信

- 生成した画像をHTTPエンドポイント経由で配信
- ストリーミング配信によるメモリ効率化
- 画像キャッシングによる高速レスポンス
- サポートエンドポイント:
  - `GET /api/charts/{chart_id}`: 画像取得
  - `GET /api/charts/{chart_id}/info`: 画像メタデータ
  - `GET /api/cache/stats`: キャッシュ統計
  - `DELETE /api/cache`: キャッシュクリア
  - `GET /health`: ヘルスチェック
受け入れ条件:
- HTTPエンドポイントから画像が正常に取得できる
- キャッシュヒット時のレスポンスが高速（< 0.1秒）
- 複数同時リクエストで安定動作

FR-017 MCPツールの画像生成対応

- 既存MCPツール（get_monthly_household, get_category_trend等）に画像生成オプションを追加
- `output_format` パラメータで出力形式を選択:
  - `"text"`: テキスト形式（デフォルト、従来通り）
  - `"image"`: 画像形式（URLを返却）
- 画像形式選択時の追加パラメータ:
  - `graph_type`: グラフタイプ
  - `image_size`: 画像サイズ
  - `image_format`: 画像フォーマット
受け入れ条件:
- テキスト形式と画像形式の両方が動作
- 画像形式選択時、画像URLが返却される
- 従来のテキスト形式の動作に影響がない

## 6. 非機能要件（NFR）

NFR-001 プライバシー: 既定で外部通信なし。明示許可時のみ外部送信
NFR-002 パフォーマンス: 取引10万件で主要クエリが2秒以内（ローカルSSD想定）
NFR-003 可用性: 単体ローカル運用で安定。異常終了時の再起動で整合性保持
NFR-004 セキュリティ: 保存データの暗号化はなし（v1）。OSユーザ権限で保護
NFR-005 画像生成性能: グラフ画像生成は3秒以内に完了
NFR-006 画像生成メモリ: 画像生成時のメモリ増分は50MB以内
NFR-007 移植性: Linuxのみで動作（x86_64/ARM64は環境に依存）
NFR-008 言語・通貨: 日本語のみ対応。通貨はJPY固定（多言語対応は不要）
NFR-009 保守性: 設定/データ/コードを分離。設定は人間可読（YAML/JSON）
NFR-010 監視性: v1では対象外（将来）
NFR-011 テスト性: サンプルデータセット/固定シナリオで再現可能
NFR-012 信頼性: 取り込み時のトランザクション性(部分失敗のロールバック/スキップ)
NFR-013 データ永続性: 重複判定結果はSQLiteで永続化。再起動後も保持
NFR-014 保守性（モジュール分離）: フロントエンドとバックエンドの責務を分離し、ディレクトリ構成・タスク定義・依存管理を独立させる
NFR-015 開発者体験（DX）: ルート/各パッケージのどちらからでも主要タスクを簡潔に実行できるよう統一化されたタスク/スクリプトを提供する

## 7. 受け入れテストシナリオ（抜粋）

TS-001 CSV取り込み正常系: マッピング適用→1000件登録→合計一致
TS-002 取り込み異常系: 不正日付/金額→行番号と理由を報告
TS-003 重複防止: 同一ファイル再取込→総件数不変
TS-003-1 重複検出(誤差なし): 日付・金額完全一致の取引ペアが検出される
TS-003-2 重複検出(日付誤差): ±1日、金額完全一致で候補検出
TS-003-3 重複検出(金額誤差): 日付完全一致、金額±10円または±1%で候補検出
TS-003-4 ユーザー確認: 重複候補の詳細表示→判定入力→DB保存
TS-003-5 重複フラグ: 重複と判定された取引が集計から除外される
TS-003-6 復元機能: 誤判定をフラグ解除で復元→集計に再度含まれる
TS-004 自動分類後の上書き: 手動修正→再分類→修正保持
TS-005 代表質問応答: 「先月の食費/固定費/収入合計/トップ3支出」回答の正確性
TS-006 予算差異: 予算設定→月次集計→差異/警告の一致
TS-007 レポート出力: 条件付CSV出力→内容とメタ一致
TS-008 バックアップ/復元: v1では対象外（将来）
TS-009 ローカル限定: ネットワーク遮断でも機能動作
TS-010 日本語エラーメッセージ: 代表エラーで自然な日本語
TS-011 画像生成: 全グラフタイプで日本語レンダリング正常→画像URL取得
TS-012 画像生成性能: 100カテゴリの円グラフ生成が3秒以内（NFR-005）
TS-013 画像生成メモリ: 大規模データセットで画像生成時のメモリ増分が50MB以内（NFR-006）
TS-014 HTTP画像配信: エンドポイント経由で画像取得→ストリーミング正常
TS-015 画像キャッシング: 同一パラメータでの2回目リクエストがキャッシュヒット→0.1秒以内
TS-016 並行画像生成: 5件同時リクエストでエラーなく完了
TS-017 リポジトリ分割（構成検証）: ルートに `backend/` と `frontend/` が存在し、両方のREADMEが更新済み
TS-018 ルート品質ゲート: ルートからAll Checks（フォーマット、Lint、型、セキュリティ、テスト）がグリーン
TS-019 バックエンド起動/テスト: `backend/` からAPIサーバ起動とpytestが成功
TS-020 フロントエンド配信: `frontend/` から静的配信（8080）が可能で主要ページが表示
TS-021 FIRE目標資産額計算: 直近12ヶ月平均月支出 × 12 × 25 が正しく計算される
TS-022 月別資産増加率: 複数月の資産推移から月利が正しく算出される
TS-023 移動平均トレンド: 3ヶ月移動平均により季節性ノイズが低減される
TS-024 到達月数予測: 現在純資産、月利、目標資産額から到達月数が数学的に正確に計算される
TS-025 シナリオ別予測: 悲観/中立/楽観シナリオの到達予定日が適切に異なる（悲観 > 中立 > 楽観）
TS-026 定常支出分離: 毎月発生する支出と季節的/臨時的支出が統計的に分離される
TS-027 ダッシュボード表示: 進捗率、到達予定日、シナリオ別予測が一画面で確認できる
TS-028 API到達率取得: `/api/financial-independence/status` から現在の到達率と進捗情報が返される
TS-029 API予測取得: `/api/financial-independence/projections` からシナリオ別予測データが返される
TS-030 API支出分類: `/api/financial-independence/expense-breakdown` から定常・臨時支出分類が返される
TS-031 Webダッシュボード表示: `financial-independence.html` がブラウザで表示可能で全要素が見える
TS-032 Webパラメータ変更: ダッシュボード内でパラメータ変更後5秒以内に結果が更新される
TS-033 Webレスポンシブ: `financial-independence.html` がPC・タブレット・モバイルで適切に表示される
TS-034 MCPツール：進捗確認: `get_financial_independence_status` が自然言語で進捗説明を返す
TS-035 MCPツール：支出分析: `analyze_expense_patterns` が定常・臨時支出と削減ポテンシャルを返す
TS-036 MCPツール：到達予測: `project_financial_independence_date` が複数シナリオの到達予定日を返す
TS-037 MCPツール：改善提案: `suggest_improvement_actions` が根拠データ付き改善案を返す
TS-038 MCPツール：シナリオ比較: `compare_scenarios` で複数改善シナリオの効果比較ができる
TS-039 MCP対話文脈: MCPツール複数回の対話で文脈が保持され、関連質問に回答できる
TS-040 MCPエラーメッセージ: MCPツールエラー時に日本語での詳細説明が返される

## 8. エッジケース/例外

- 文字コード混在（UTF-8, Shift_JIS）
- 日付形式混在（YYYY/MM/DD, DD-MM-YYYY）
- 返金/払い戻し（負金額）、ゼロ金額
- 摘要のノイズ/絵文字/長文
- タイムゾーン跨ぎ月末処理
- 口座間振替（実質収支0）
- - 重複だが微差(メモのみ差異)
- 同日同額の複数取引(実際には別物、例:同じ店で朝夜に買い物)
- 多通貨・為替換算（v1対象外）
- 非常に大きい単発支出（異常値扱い）

## 9. 成功基準

- 代表シナリオ（TS-001〜TS-010）を再現可能
- 10万件規模で実用応答
- ローカルのみで一連の運用が完結

## 10. トレーサビリティ

- FRとTSを相互参照（例: FR-001 ↔ TS-001/002/003）

## 10.1. Webアプリケーション要件（FR-018）

FR-018 Webベースのインタラクティブ分析UI

- ユーザーはブラウザから家計簿データを可視化・操作できる
- HTTPサーバ経由でバックエンドAPIと通信する
- サーバー実装とは独立したフロントエンドとして管理する

受け入れ条件:

- 年月選択により月次データを表示できる
- 円グラフ・棒グラフ・折れ線グラフでデータを可視化できる
- データテーブルで取引明細を表示し、検索・フィルタリングできる
- 統計サマリー（総支出、取引件数、平均、最大）を表示できる
- モバイル・タブレット・PCで適切に表示される（レスポンシブデザイン）
- バックエンドAPIが利用できない場合にエラーメッセージを表示する

FR-018-1 REST APIエンドポイント

- `GET /api/monthly`: 月次データ取得（JSON形式）
- `GET /api/available-months`: 利用可能な年月リスト
- `GET /api/category-hierarchy`: カテゴリ階層情報
- 既存のチャート画像エンドポイント（`/api/charts/{chart_id}`）を活用

受け入れ条件:

- 各エンドポイントが適切なJSONレスポンスを返す
- エラー時にHTTPステータスコードとエラーメッセージを返す
- CORS設定により異なるポートからのアクセスを許可する

FR-018-2 フロントエンド実装

- Vanilla JavaScript（ES6+）でSPA風のUIを実装
- Chart.jsによるインタラクティブなグラフ表示
- 非同期通信によるスムーズなデータ読み込み
- ローディングインジケーターとエラーハンドリング

受け入れ条件:

- 外部フレームワークに依存しない（Vanilla JS + Chart.js CDN）
- XSS対策が施されている
- ブラウザコンソールにエラーが出ない

FR-019 収支トレンド可視化機能

- ユーザーは複数月の収支推移をグラフで可視化できる
- 期間を指定して月次トレンドを表示する
- カテゴリ別の推移を確認できる
- プリセット期間（直近3/6/12ヶ月、全期間）で素早く表示できる

受け入れ条件:

- 開始年月〜終了年月を選択して期間指定できる
- 月次推移（収入・支出・収支差額）を折れ線グラフで表示できる
- 累積収支を折れ線グラフで表示できる
- カテゴリ別トレンドを積み上げグラフで表示できる
- プリセットボタン（直近3ヶ月、6ヶ月、12ヶ月、全期間）で期間を素早く設定できる
- デフォルト表示は直近3ヶ月
- タブでグラフ種類を切り替えられる

FR-019-1 トレンド分析APIエンドポイント

- `GET /api/trend/monthly_summary`: 期間指定で月次収支サマリーを取得
  - パラメータ: start_year, start_month, end_year, end_month
  - レスポンス: 月別の収入・支出・収支差額・累積収支のリスト
- `GET /api/trend/category_breakdown`: 期間指定でカテゴリ別推移を取得
  - パラメータ: start_year, start_month, end_year, end_month, top_n（デフォルト5）
  - レスポンス: 主要カテゴリの月次推移データ

受け入れ条件:

- 期間パラメータが正しく処理される
- データが存在しない月は0として返される
- エラー時に適切なHTTPステータスとメッセージを返す

FR-019-2 トレンドUI実装

- メインページにタブUIを追加（「月次分析」「トレンド分析」）
- 期間選択UI（年月ドロップダウン × 2 + プリセットボタン）
- 複数のトレンドグラフをタブで切り替え表示
- グラフ切り替えタブ（「月次推移」「累積収支」「カテゴリ別」）

受け入れ条件:

- タブ切り替えがスムーズに動作する
- グラフが見やすく表示される
- 期間選択が直感的に操作できる
- プリセットボタンで即座に期間が設定される
- レスポンシブデザインが維持される

## 10.2. リポジトリ構成分割（FR-020）

FR-020 フロントエンド/バックエンド分割とモノレポ構成

- リポジトリをフロントエンド（web UI）とバックエンド（MCPサーバ/API）に分割し、トップレベルに以下のディレクトリを配置する
  - `backend/`（Python: MCPサーバ、API、ライブラリ、テスト、ドキュメント）
  - `frontend/`（Webアプリ: 静的アセット、ビルド設定、テスト、ドキュメント）
  - `shared/`（任意・将来）：スキーマ/定数/ドキュメントの共有領域（当面は空でも可）
- 既存の `src/`、`tests/`、`docs/` 等は新構成へ移設する
- ルートには開発者向けのメタファイルのみを残す（例: README、リポジトリ全体のガイド、Makefile/タスク）
- タスク実行・サーバ起動・テスト実行は、ルートと各パッケージ（backend/frontend）いずれからも実行できる
- CI/品質ゲート（フォーマット、Lint、型、セキュリティ、テスト）が新構成でグリーンになる

受け入れ条件:

- ルート直下に `backend/` と `frontend/` が存在し、それぞれにREADMEがある
- 既存のPythonコード（MCPサーバ、API）は `backend/` 配下へ移動し、`uv run pytest` でテストが成功する
- 既存のWeb静的ファイルは `frontend/` 配下へ移動し、`python -m http.server 8080` 等で配信できる（暫定で可）
- ルートの開発タスク（フォーマット、Lint、型、セキュリティ、テスト、サーバ起動）が新構成に追従して動作する
- 既存のドキュメントとスクリプトの参照パスが更新されている（リンク切れがない）
- Start Full Webapp Stack 相当の開発体験（API サーバ + フロントエンド）が維持される
- READMEとdocsに新しい構成が図解/記述されている

## 11. MCP ツール実行フロントエンド機能（FR-021）

FR-021 手動 MCP ツール実行UIの実装

概要：

- フロントエンドで利用可能なMCPツール（get_monthly_household, get_category_trend, detect_duplicates等）をギャラリー形式で表示し、ユーザーが各ツールを手動実行できるページを追加する

要件詳細：

1. **ページ構成**
   - 現在のメインページ（月次分析・トレンド分析タブ）とは独立した新ページを作成する
   - トップページ（index.html）に「MCPツール実行」への分岐リンクを追加
   - 新ページを `mcp-tools.html` として実装

2. **ツール一覧表示（ギャラリー形式）**
   - MCPツール一覧ページでは、API経由で利用可能なツール定義を取得
   - 各ツール1枚のカード（Card UI）で表示
   - カード内容：
     - ツール名（日本語/英語）
     - ツール説明/用途
     - 必須パラメータ一覧
     - オプションパラメータ一覧
     - 「このツールを実行」ボタン

3. **ツール実行フロー**
   - ユーザーがカードの「実行」ボタンをクリック → モーダルダイアログで入力フォーム表示
   - パラメータ型に応じた入力フィールド生成（文字列、数値、日付、選択肢等）
   - デフォルト値があれば自動入力
   - 実行ボタン → HTTP API (POST /api/tools/{tool_name}/execute) でバックエンドに送信
   - 実行結果をモーダルに表示（テキスト/テーブル/グラフ等）

4. **バックエンド API設計**
   - `GET /api/tools` - 利用可能なツール一覧と定義を返す
   - `GET /api/tools/{tool_name}` - 指定ツールの詳細定義を返す
   - `POST /api/tools/{tool_name}/execute` - ツール実行（パラメータをJSON本体で受け取り）

5. **対応ツール（初期版）**
   - `get_monthly_household`: 月次取引明細の取得
   - `get_category_trend`: カテゴリ別トレンド分析
   - `detect_duplicates`: 重複候補検出
   - `get_duplicate_candidates`: 未判定の重複候補取得
   - `confirm_duplicate`: 重複判定の記録
   - 将来: `restore_duplicate`, `get_duplicate_stats` 等

受け入れ条件:

- `mcp-tools.html` が作成され、アクセス可能（トップページからのリンク）
- ギャラリーに5個以上のツールカードが表示される
- 各カードにツール名、説明、パラメータが明示されている
- 「このツールを実行」をクリックするとモーダルで入力フォームが表示される
- パラメータ入力後に「実行」をクリックすると、HTTP APIで バックエンドにリクエストが送信される
- 結果がモーダルに表示される（成功時：テキスト/テーブル、エラー時：エラーメッセージ）
- `/api/tools` と `/api/tools/{tool_name}` エンドポイントが動作する
- `/api/tools/{tool_name}/execute` エンドポイントが動作する
- レスポンシブデザインが維持される

## 11.1. 資産推移分析機能（FR-022）

FR-022 資産推移分析機能

- ユーザーは複数の資産クラス（現金、株、投資信託、不動産、年金）の時系列データを手動登録し、資産推移を可視化・分析できる
- 資産データは独立して管理される（家計簿の収支との連携は将来実装）
- 将来的に運用実績シミュレーションや資産配分最適化機能への拡張を見据えた基盤を構築

## 11.2. 経済的自由への到達率可視化機能（FR-023）

FR-023 経済的自由への到達率可視化

- ユーザーは現在の資産状況から経済的自由（FIRE基準）への到達率をリアルタイムで把握できる
- 到達率は現在の純資産と目標資産額（FIRE基準で算出）の比率で定義
- 月別の資産増加トレンドから到達予想時期を計算し、複数のシナリオ予測に対応する

前提条件：

- FR-022（資産推移分析機能）の資産データを利用する
- FR-001〜FR-005（家計簿データ）の支出データを利用する

受け入れ条件：

- 現在の純資産から目標資産額（年支出 × 25）までの進捗率が正確に計算される
- 資産の月別増加率から月利を算出し、目標到達までの月数が予測される
- トレンド分析により定常支出と臨時支出が分離できる
- 複数の貯蓄シナリオ（楽観的/中立的/悲観的）での到達予測が可能
- ダッシュボードで到達率・到達予定日・シナリオ別予測が一目で把握できる

FR-023-1 FIRE基準に基づく目標資産額計算

- 目標資産額 = 年支出額 × 25（FIRE基準）
- 年支出額は家計簿データから以下の方法で算出：
  - 分析対象期間（ユーザーが指定、デフォルト：直近12ヶ月）の平均月支出 × 12
  - または、ユーザーが独自の年支出額を設定可能
- 支出額は、検証済み（重複フラグが立っていない）かつ、臨時支出を除いた定常支出のみを対象とする

受け入れ条件：

- 指定期間の月別支出が正しく計算される
- 年支出額が適切に計算され、FIRE基準での目標資産額が導出される
- ユーザー独自値の設定がある場合は、それを優先する

FR-023-2 月別資産増加率の計算とトレンド分析

- 資産管理システムの月末残高データから月別増減を計算
- 計算対象：直近12ヶ月（またはユーザーが指定する期間）
- 月別の増加率（%）を算出し、トレンドを分析
- トレンド分析により、以下の指標を導出：
  - **移動平均（3ヶ月）**：季節性やノイズを低減した平均的な増加率
  - **回帰分析**：資産増加のトレンド（加速/減速/横ばい）の判定
  - **定常・臨時分離**：支出側でも同様に実施し、安定した増加パターンを抽出

受け入れ条件：

- 月別増加率（月利）が正しく計算される
- 3ヶ月移動平均が算出され、トレンドの安定性が判定できる
- 定常・臨時の分離により、保守的な予測が可能

FR-023-3 到達時期の予測計算

- 現在の純資産と月利から、目標資産額に到達するまでの月数を計算
- 計算式：到達月数 = log（目標資産額 / 現在の純資産）/ log（1 + 月利）
- 複合金利効果を考慮した指数型成長モデルを採用
- ユーザーが設定可能なパラメータ：
  - 分析対象月の選択（直近12/24/36ヶ月、全期間）
  - 月利の種類（移動平均、回帰トレンド、ユーザー設定値）

受け入れ条件：

- 到達月数が数学的に正確に計算される
- ユーザーが複数の月利オプション（過去トレンド、保守的値、楽観的値）を選択できる
- 到達予定日が計算される（現在日付 + 到達月数 → 年月）

FR-023-4 シナリオ別予測（複数の貯蓄パターン）

- ユーザーが以下の3つのシナリオで到達予測を比較可能：
  - **悲観シナリオ**：直近12ヶ月の最小月利を適用（または指定値）
  - **中立シナリオ**：直近12ヶ月の移動平均月利を適用
  - **楽観シナリオ**：直近12ヶ月の最大月利を適用（または指定値）
- 各シナリオで「到達予定日」と「年間資産増加額目安」を表示
- ユーザーが独自のシナリオパラメータ（月利、月間支出増加率等）を設定可能

受け入れ条件：

- 3つのシナリオが併行して計算・表示される
- 各シナリオの到達予定日が異なる（悲観 > 中立 > 楽観の順）
- ユーザー独自シナリオが5パターンまで登録・保存可能

FR-023-5 定常支出と臨時支出の分離

- 家計簿データから「定常支出」と「臨時支出」を自動検出し分離
- 分離ロジック：
  - **定常支出**：対象期間内で毎月（または大半の月）に発生するカテゴリ/金額の支出
  - **臨時支出**：特定月に集中する支出、または特異値（通常の3倍以上等）
  - カテゴリ別の月別推移から、統計的手法（標準偏差、四分位数等）により検出
- 定常支出のみを対象に、より信頼度の高い予測を実施
- ユーザーが定常/臨時の分類を手動で調整可能

受け入れ条件：

- 定常支出と臨時支出が明確に分離される
- 定常支出合計が実績と一致する
- ユーザーが分類を修正でき、修正後に再計算が可能
- カテゴリ別の定常/臨時分類結果が表示される

FR-023-6 ダッシュボード表示

- 新しいページ `financial-independence.html` を追加
- 以下の要素で構成：
  1. **進捗インジケータ**
     - 現在の純資産 / 目標資産額（% 表示、プログレスバー）
     - 目標までの残高差
  2. **到達予定日の表示（複数シナリオ）**
     - 中立シナリオ：到達予定年月
     - 悲観/楽観シナリオ：到達予定年月の範囲（早い〜遅い）
  3. **資産・収支トレンドグラフ**
     - 資産推移（左Y軸、単位：円）
     - 月別増加額（右Y軸、単位：円/月）
     - 定常支出の推移
  4. **シナリオ別到達時期の比較グラフ**
     - 棒グラフで3シナリオの到達月数を視覚化
  5. **定常・臨時支出の内訳**
     - カテゴリ別の定常/臨時分類結果をテーブル表示
     - ユーザーが分類を修正可能なUI
  6. **パラメータ設定パネル**
     - 分析対象月の選択（プリセット + カスタム）
     - 年支出額の手動設定
     - シナリオパラメータの調整
     - 計算実行ボタン

受け入れ条件：

- `financial-independence.html` が作成・アクセス可能
- トップページから「経済的自由への進捗」へのリンクが追加される
- 全要素がレスポンシブデザインで表示される
- パラメータ変更時に計算が実行され、結果が即座に更新される

FR-023-7 API エンドポイント

- `GET /api/financial-independence/status` - 現在の到達率と進捗情報
  - パラメータ：期間指定（オプション）
  - レスポンス：現在の純資産、目標資産額、到達率、到達予定日（複数シナリオ）
- `GET /api/financial-independence/projections` - シナリオ別到達予測
  - パラメータ：期間指定、シナリオ選択（オプション）
  - レスポンス：各シナリオの到達予定日、月利、年間増加額等
- `GET /api/financial-independence/expense-breakdown` - 定常・臨時支出の分離結果
  - パラメータ：期間指定
  - レスポンス：カテゴリ別の定常/臨時分類、定常支出合計
- `POST /api/financial-independence/update-expense-classification` - 定常・臨時分類の更新
  - パラメータ：カテゴリID、新分類値（定常/臨時）
  - レスポンス：更新結果、再計算した到達率

受け入れ条件：

- 全エンドポイントが機能し、適切なJSONレスポンスを返す
- エラーハンドリングが実装される（期間不足時等）
- 複数同時リクエストで安定動作

FR-023-8 Webアプリケーション実装

- 経済的自由到達率ダッシュボード（FR-023-6）を `financial-independence.html` として実装
- Vanilla JavaScript + Chart.js を用いた、インタラクティブなUI
- リアルタイムでパラメータ変更時に計算結果を更新
- モバイル・タブレット・PCで適切に表示される（レスポンシブデザイン）

受け入れ条件：

- `financial-independence.html` がブラウザで表示可能
- トップページ（index.html）から「経済的自由への進捗」へのリンクが追加される
- 全要素がレスポンシブデザインで表示される
- パラメータ変更後5秒以内に結果が更新される
- ブラウザコンソールにエラーが出ない

FR-023-9 MCP ツール：進捗確認と改善点発見

- ユーザーが自然言語で以下のような会話を通じて、経済的自由への進捗確認と改善点の発見ができるMCPツールを実装
- 対話的なツールにより、ユーザーが質問・相談しながら現状分析と改善策の検討が可能

具体的なMCPツール：

1. **get_financial_independence_status**
   - ユーザー問合わせ例：「今、経済的自由まであとどのくらい？」「現在の到達率は？」
   - 機能：現在の到達率、目標資産額、到達予定日を自然言語で返答
   - パラメータ：期間指定（オプション）
   - レスポンス：日本語での進捗説明、数値、図表データ

2. **analyze_expense_patterns**
   - ユーザー問合わせ例：「定常支出と臨時支出の内訳は？」「支出でどこが削減できそう？」
   - 機能：定常・臨時支出の分離結果を分析し、削減可能性のあるカテゴリを提示
   - パラメータ：期間指定、分析対象カテゴリ（オプション）
   - レスポンス：カテゴリ別の定常/臨時分類、削減ポテンシャル（金額・%）

3. **project_financial_independence_date**
   - ユーザー問合わせ例：「このままのペースで経済的自由にいつ到達できる？」「月5万円多く貯蓄できたら？」
   - 機能：複数シナリオでの到達予定日を計算し、改善シナリオの効果を提示
   - パラメータ：基本シナリオ選択、月間追加貯蓄額（オプション）、期間（オプション）
   - レスポンス：各シナリオの到達予定日、短縮効果（月数）

4. **suggest_improvement_actions**
   - ユーザー問合わせ例：「経済的自由に向けて、何をすればいい？」「支出削減以外の方法は？」
   - 機能：現在のデータを分析し、実行可能な改善アクション候補を提示
   - パラメータ：重点分野選択（支出削減/収入増加/資産運用）（オプション）
   - レスポンス：優先度付き改善提案リスト（根拠データ付き）

5. **compare_scenarios**
   - ユーザー問合わせ例：「支出を10%削減 vs 資産運用利回り1%上げたら、どちらが効果的？」
   - 機能：複数の改善シナリオを同時に比較し、効果の大きさと実行難易度を提示
   - パラメータ：比較対象シナリオ（複数）
   - レスポンス：各シナリオの効果比較、優先度提案

受け入れ条件：

- 5つのMCPツールが全て実装される
- 各ツールが日本語での自然な説明を返す
- パラメータ指定がない場合、デフォルト値（直近12ヶ月等）を適用
- 複数回の対話を通じて、前の回答の文脈を保持可能（MCPコンテキスト活用）
- 各ツールが提供するデータに根拠（集計期間、データ件数等）が明記される
- エラー時に日本語での詳細なエラーメッセージが返される

FR-022-1 資産クラス定義

- システムが以下5つの資産クラスをサポート（固定）：
  - 現金（現金・預金）
  - 株（国内株・外国株を含む）
  - 投資信託
  - 不動産（土地・建物・投資用不動産を含む）
  - 年金（確定拠出年金・個人年金等を含む）
- 各資産クラスには任意のサブ資産を登録可能（例：「現金」に「普通預金」「定期預金」等）
- 資産クラスと階層情報をAPI経由で取得可能

受け入れ条件：

- APIエンドポイント `GET /api/assets/classes` で資産クラス定義がJSON形式で返却される
- 各資産クラスに複数のサブ資産を紐付けて登録できる

FR-022-2 資産データの登録・編集・削除

- ユーザーは以下の情報で資産を登録・編集：
  - 登録日（YYYY-MM-DD）
  - 資産クラス（5つの固定値から選択）
  - サブ資産名（テキスト、例：「普通預金」「楽天VTI」等）
  - 金額（JPY）
  - メモ（任意）
- 登録データはSQLiteに永続化される
- 手動登録のため、API経由またはUIで1件ずつ登録・編集
- 削除機能も実装（論理削除、フラグで管理）

受け入れ条件：

- APIエンドポイント `POST /api/assets/records` で資産を登録でき、DBに保存される
- APIエンドポイント `PUT /api/assets/records/{record_id}` で資産を編集でき、DBに反映される
- APIエンドポイント `DELETE /api/assets/records/{record_id}` で資産を削除でき、DBに反映される
- 同一日付に同じサブ資産で複数件の登録が可能
- 登録・編集・削除の入力値検証が実施される（日付形式、金額の正値性等）

FR-022-3 資産データの取得と集計

- 指定期間の資産推移を集計可能：
  - 月末時点での資産クラス別残高
  - 資産クラス別の推移データ（複数月）
  - 全資産の合計と配分
- APIエンドポイント `GET /api/assets/records` で日付範囲・資産クラス別でフィルタリング可能
- APIエンドポイント `GET /api/assets/summary` で期間指定（開始年月～終了年月）により集計データを取得可能

受け入れ条件：

- 期間指定で月末時点の残高が正しく集計される
- 複数の資産クラスの推移データが取得できる
- 存在しない月に対して、前月の値を引き継ぐか0として扱うかを選択可能

FR-022-4 資産推移の可視化UI

- フロントエンドに新しいページ `assets.html` を追加
- 以下のセクションを実装：
  - **資産登録フォーム**：日付、資産クラス、サブ資産名、金額、メモを入力
  - **資産一覧**：登録済み資産をテーブルで表示（日付・クラス・サブ資産名・金額、編集・削除ボタン）
  - **資産推移グラフ**：期間指定（プリセット：直近3/6/12ヶ月、全期間）で折れ線グラフ表示
  - **資産配分グラフ**：月末時点での資産クラス別配分を円グラフで表示
  - **統計サマリー**：合計資産額、前月比、最大資産額等

受け入れ条件：

- `assets.html` が作成・アクセス可能
- トップページから「資産管理」へのリンクが追加される
- 資産登録フォームで新規登録ができる
- 登録された資産が一覧テーブルに表示される
- 一覧から編集・削除が可能
- 期間指定で推移グラフ・配分グラフが表示される
- レスポンシブデザインが維持される

FR-022-5 資産データのエクスポート

- ユーザーは登録済み資産をCSVでエクスポート可能
- エクスポートには日付範囲・資産クラス指定が可能

受け入れ条件：

- APIエンドポイント `GET /api/assets/export?format=csv&start_date=...&end_date=...` でCSV取得可能
- CSVに日付、資産クラス、サブ資産名、金額、メモが含まれる

FR-022-6 資産データの家計簿連携設計（基盤）

- 資産データテーブルに以下の予約フィールドを実装：
  - `is_manual`: Boolean（手動登録=True）
  - `source_type`: Enum（「manual」「linked」「calculated」等、現状は全て「manual」）
  - `linked_transaction_id`: NULL（将来の収支リンク用、現状は未使用）
- v1.2では手動登録のみを実装（全レコード `is_manual=True`）
- 将来的に収支データとの自動連携時に拡張

受け入れ条件：

- 資産テーブルに上記フィールドが実装されている
- 現状は全て `is_manual=True, source_type='manual'` で登録
- データベース設計書に将来の連携仕様が記載されている

非機能要件：

- NFR-022: 資産登録・編集・削除時のレスポンスは1秒以内
- NFR-023: 資産推移グラフの生成は3秒以内
- NFR-024: 10年分（1000件）の資産データで月次集計が1秒以内に完了
- NFR-025: 経済的自由到達率の計算は5秒以内に完了
- NFR-026: 定常・臨時支出の分離は10秒以内に完了（12ヶ月分析対象時）
- NFR-027: 到達率ダッシュボードの全要素のレンダリングは3秒以内に完了

## 12. 決定事項（Q1〜Q10反映、Q11〜Q13は資産推移分析）

- Q1: 入力はCSVを優先（v1はCSVのみ対応）
- Q2: 通貨はJPYのみ
- Q3: プロファイルは単一想定（マルチは将来）
- Q4: カテゴリ体系はMoneyForward形式を採用
- Q5: 予算はサブカテゴリ粒度、期首は月初固定
- Q6: MCPクライアントはテキスト対話のみでOK
- Q7: 保存場所は data/、バックアップなし、暗号化なし
- Q8: ログ保持は不要（監査ログは将来）
- Q9: 異常値検出は現時点で検討不要（将来）
- Q10: 対応OSはLinuxのみ
- Q11: 資産クラスはサブカテゴリなし（現金、株、投資信託、不動産、年金の5つ固定、サブは任意フリーテキスト）
- Q12: 資産は独立管理（家計簿との連携は将来実装）
- Q13: 修正機能は初期実装版から含める
- Q14: 経済的自由の基準はFIRE基準（年支出 × 25）を採用
- Q15: 到達月数の計算は複合金利効果を考慮した指数型成長モデルを使用
- Q16: 定常・臨時支出の分離は統計的手法（標準偏差、四分位数等）により自動検出し、ユーザーが手動調整可能とする
- Q17: シナリオ別予測は3つの基本シナリオ（悲観/中立/楽観）+ ユーザーカスタム最大5パターンに対応
- Q18: 経済的自由到達率機能の実装は Webアプリ（UI）と MCPツール（会話ベース）の両方で行う
- Q19: MCPツールは「進捗確認」と「改善点発見」の2つの観点で設計し、ユーザーの意思決定を支援する

## 13. 承認記録

### FR-018: Webベースのインタラクティブ分析UI

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-01
- **概要**: ブラウザベースのWebアプリケーションにより、家計データを可視化・操作するUI を実装。REST APIエンドポイント と Vanilla JS + Chart.js によるフロントエンドで構成
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（frontend/ に統合済み）

### FR-019: 収支トレンド可視化機能

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-01
- **概要**: 複数月の収支推移をグラフで可視化するトレンド分析UIを実装。期間指定・プリセット・複数グラフ形式に対応
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（frontend/index.html のトレンドタブに統合済み）

### FR-020: フロントエンド/バックエンド分割とモノレポ構成

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-02
- **概要**: リポジトリを backend/ と frontend/ に分割し、モノレポ構成を採用。各パッケージの独立性と統合性を両立
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（ディレクトリ構成・CI/CD・ドキュメント整備済み）

### FR-021: MCP ツール実行フロントエンド機能

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-04
- **概要**: フロントエンドで利用可能なMCPツールをギャラリー形式で表示し、ユーザーが各ツールを手動で実行できるUIを実装
- **受け入れ条件**: 全て明記済み
- **次ステップ**: design.md での技術設計に進む

### FR-022: 資産推移分析機能

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-04
- **概要**: 5つの資産クラス（現金、株、投資信託、不動産、年金）の時系列データを手動登録・管理し、資産推移を可視化・分析。資産は独立として管理され、将来の家計簿連携に備えた基盤構築
- **受け入れ条件**: 全て明記済み（サブカテゴリなし、修正機能初期実装）
- **次ステップ**: design.md での技術設計に進む

### FR-023: 経済的自由への到達率可視化

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-05
- **概要**: FIRE基準（年支出 × 25）に基づいた目標資産額を自動算出。資産の月別増加トレンドから月利を計算し、複数シナリオ（悲観/中立/楽観）での到達予定日を予測。定常支出と臨時支出を分離して、より信頼度の高い予測を実施。ダッシュボードで進捗率・到達予定日・シナリオ別予測を一元表示。加えて、MCPツール（5つの会話ベースツール）により、ユーザーが自然言語で進捗確認と改善点発見ができるようにする
- **実装方式**: Webアプリ（financial-independence.html）+ MCPツール（get_financial_independence_status, analyze_expense_patterns, project_financial_independence_date, suggest_improvement_actions, compare_scenarios）
- **受け入れ条件**: 全て明記済み（9つのサブ要件FR-023-1〜FR-023-9を含む）
- **次ステップ**: design.md での技術設計に進む

### FR-024: SQLite データベース統合

- **ステータス**: 🔷 検討中
- **概要**: 家計簿取引データ・資産管理データを SQLite データベースに永続化。現在のメモリ内 CSV 読み込みから段階的に移行し、大規模データセット対応・クエリ性能最適化・バージョン管理を実現
- **機能分類**:
  - FR-024-1: SQLiteスキーマ設計と初期化処理
  - FR-024-2: 既存 CSV データの SQLite 取り込み（マイグレーション）
  - FR-024-3: 取引データの CRUD API 実装
  - FR-024-4: 資産管理データの CRUD API 実装
  - FR-024-5: 集計クエリの最適化（インデックス活用）
  - FR-024-6: トランザクション管理とロールバック機能
  - FR-024-7: データベース健全性チェック・修復機能
  - FR-024-8: バージョンマイグレーション機構

受け入れ条件:

- SQLiteデータベースが data/household.db に作成される
- 既存 CSV 1000件以上が正しく取り込まれる
- CRUD 操作のレスポンスタイム ≤ 200ms（100件取引以下）
- トランザクション失敗時は確実にロールバック
- スキーマバージョン管理により将来の拡張に対応
- 集計クエリ（月次/カテゴリ別）が 1 秒以内に完了

非機能要件の追加:

- NFR-028: SQLiteコネクションプーリング（最大 5 コネクション）
- NFR-029: ログレベル（DEBUG/INFO/WARNING）の設定可能化
- NFR-030: 定期バックアップ機構（ユーザーが手動トリガー可能）
- NFR-031: データベースロック時のリトライ機構（最大 3 回、100ms 間隔）
- NFR-032: スローログ記録（実行時間 > 1000ms のクエリを自動ログ）

---

## 全体承認ステータス

本ドキュメントに記載された全要件（FR-001〜FR-024, NFR-001〜NFR-032）の内、FR-001〜FR-023 は承認済みです。
FR-024 および追加 NFR-028〜032 は Phase 13 で検討予定です。

---

## Phase 15: 高度な分析機能

本フェーズでは、家計データをさらに活用して、ユーザーの財務目標達成支援に特化した高度な分析ツール群を実装します。

### 目的

- 金融独立（FIRE）目標の達成期間を精密に予測
- 支出削減・収入増加のシナリオを複数比較し、最適な改善施策を提案
- 定期支出・変動支出・異常支出を自動分類し、異常検知
- これらの分析結果を MCP リソース・HTTP API として公開

## Phase 15 機能要件（FR-025〜FR-030）

### FR-025: 金融独立度計算エンジン

**目的**: 現在資産と月貯蓄から、経済的自由到達月を正確に計算

**詳細**:

- 入力: 現在資産額、月貯蓄額、目標資産額、年利回り、インフレ率
- 出力: 達成予定年月、複利シミュレーション（月別資産推移）
- 考慮項目:
  - 複利効果（月単位での利息/配当を逐次計算）
  - インフレ調整（実質購買力の減少を予測）
  - 複数シナリオ（悲観: 年利 3%、中立: 5%、楽観: 7%）
  - 臨時支出の影響
  - 社会保障控除の概算

**受け入れ条件**:

- 月利計算が年利から正しく導出される
- 複利効果がシミュレーション結果に反映
- インフレを考慮した場合と非考慮の結果の差が適切（2% インフレで実質資産が 98% になる）
- シナリオ別に異なる到達月が出力される
- 目標到達不可のケース（支出 > 収入）も適切に処理

**非機能要件**:

- 計算時間 < 100ms（標準シナリオ）
- 計算精度：小数第 2 位まで正確

---

### FR-026: シナリオ分析・最適化ツール

**目的**: 支出削減・収入増加の複数パターンを試算し、最適な改善施策を提案

**詳細**:

- シナリオ定義:
  - 支出削減: 特定カテゴリの支出を X% 削減（e.g., 食費 10% 削減）
  - 収入増加: 月収を Y 円増加（e.g., 副業 50,000 円/月）
  - 複合: 複数の削減・増加を組み合わせ
- シナリオ比較:
  - 各シナリオの到達月を計算
  - 到達月の短縮期間を表示
  - 実行難易度スコア（心理的コスト）を付与
- 最適化推奨:
  - ROI（実行難易度 vs 効果）が最も高いシナリオを推奨

**受け入れ条件**:

- 複数シナリオ（3〜5 個）の比較が可能
- 各シナリオで到達月が異なる結果が出力される
- 推奨シナリオが適切に選定される
- 支出削減の合計が月支出を超える場合の警告

**テスト項目**:

- シナリオ作成・保存・読み込み
- シナリオ間の比較計算
- 推奨シナリオの選定ロジック
- エッジケース（収入 = 支出など）

---

### FR-027: 支出パターン分析・異常検知

**目的**: 定期支出・変動支出・異常支出を自動分類し、異常値を検出

**詳細**:

- 分類方式:
  - **定期支出**: 毎月ほぼ一定額（給与、家賃、保険料など）
    - 判定: 3 か月以上の同一カテゴリで 変動率 < 5% の場合
  - **変動支出**: カテゴリ内で月により変動（食費、交通費など）
    - 判定: 3 か月以上の履歴で 標準偏差を計算、平均 ± 2σ 範囲
  - **異常支出**: 変動支出の平均 + 2σ を超える支出
    - 判定: 上記範囲外かつ月 1 回程度の低頻度
- 季節性検出:
  - 12 か月データから季節パターンを検出（e.g., 12 月の支出増加）
  - 月別の支出指数を計算（平均 = 100）
- トレンド分析:
  - 線形回帰で支出トレンドを計算（増加/減少傾向）
  - 傾きと R² を出力

**受け入れ条件**:

- 定期支出が正しく分類される
- 異常支出が検出される（その他支出など真の異常値を検出）
- 季節パターンが視覚化できる（月別グラフ）
- トレンドが正確に計算される

**テスト項目**:

- 3 種類の分類が正しく行われる
- 季節性指数の計算
- トレンド検出の精度
- 新規カテゴリ（データ < 3 か月）の処理

---

### FR-028: MCPリソース・ツール公開

**目的**: Phase 15 で実装した分析ツール群を MCP リソース・HTTP API として公開

**詳細**:

- MCP リソース:
  - `data://financial_independence`: FIRE 計算結果
  - `data://scenarios`: シナリオ分析結果
  - `data://expense_patterns`: 支出パターン分析
- MCPツール:
  - `calculate_fire_index()`: 金融独立度計算
  - `simulate_scenarios()`: シナリオシミュレーション
  - `analyze_spending_patterns()`: 支出パターン分析
- HTTP API エンドポイント:
  - `GET /api/v1/financial-independence` - FIRE 計算
  - `POST /api/v1/scenarios` - シナリオ分析
  - `GET /api/v1/spending-patterns` - 支出パターン分析
- ドキュメント:
  - OpenAPI 仕様
  - 使用例

**受け入れ条件**:

- MCP リソースが `list_resources()` で表示される
- HTTP API が curl/Python requests で動作
- レスポンス時間 < 1s
- エラーレスポンス（400/500）が適切に返却される

---

### FR-029: 統合テスト・性能検証

**目的**: Phase 15 全体の品質と性能を検証

**詳細**:

- E2E テスト（15+):
  - ツール間の連携テスト（FIRE計算→シナリオ分析→パターン検出）
  - データベース操作との統合テスト
  - 後方互換性テスト（Phase 13/14 との互換性）
- パフォーマンステスト:
  - FIRE 計算: < 100ms
  - シナリオ分析（5 シナリオ）: < 500ms
  - パターン分析（12 か月データ）: < 300ms
  - API レスポンス: < 1s
- 品質ゲート:
  - カバレッジ: ≥ 80%（新規コード）
  - 予期しない例外なし
  - メモリリーク検査

**受け入れ条件**:

- E2E テスト 15+ が全て PASSED
- 全パフォーマンスメトリクスが閾値以内
- カバレッジが 80% 以上

---

### FR-030: ドキュメント・デリバリー準備

**目的**: Phase 15 リリースに向けた最終準備

**詳細**:

- ドキュメント更新:
  - README: Phase 15 の新機能説明・インストール手順更新
  - docs/: FIRE 計算ロジック・シナリオ分析方式の詳細説明
  - 設計ドキュメント: アーキテクチャ・モジュール設計
- CHANGELOG 生成:
  - towncrier で自動生成（v1.5-beta リリース）
  - 機能追加・バグ修正・非互換変更の分類
- リリースノート:
  - 新機能のハイライト
  - アップグレード手順
  - 既知の制限事項

**受け入れ条件**:

- README が最新の機能を反映
- CHANGELOG が自動生成される
- デプロイメント手順が明記される

---

## 非機能要件の追加（Phase 15）

- **NFR-033**: 分析計算の数値精度は小数第 2 位まで（金銭）
- **NFR-034**: シナリオ保存は JSON 形式、ユーザーが編集可能
- **NFR-035**: パターン分析結果のキャッシング（24 時間有効）
- **NFR-036**: 分析ツール実行時のログレベル DEBUG で詳細ログ出力

---

## Phase 15 承認状況

以下の要件は計画中（Phase 15 開始時に承認予定）:

- FR-025: 金融独立度計算エンジン
- FR-026: シナリオ分析・最適化ツール
- FR-027: 支出パターン分析・異常検知
- FR-028: MCPリソース・ツール公開
- FR-029: 統合テスト・性能検証
- FR-030: ドキュメント・デリバリー準備
- NFR-033〜NFR-036: 非機能要件
