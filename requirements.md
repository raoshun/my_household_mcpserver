# Household Budget Analysis MCP Server - 要件定義（requirements.md）

- バージョン: v1.2
- 日付: 2025-11-01
- 作成者: GitHub Copilot
- 対象: 個人/世帯向け 家計分析用 MCP サーバ
- 言語: 日本語（優先）
- ステータス: 承認済み（Q1〜Q10反映 + 画像生成機能 + Webアプリ追加）

## 1. 概要

本システムは、ローカル環境で家計データを安全に取り扱い、自然言語（日本語）での対話を通じて収支の可視化・分析・予算管理を行う MCP（Model Context Protocol）サーバです。プライバシーファーストを重視し、原則ローカル処理・ローカル保存とします。

## 2. 範囲

- 含む: 取引データの取り込み・正規化・分析・対話的な質問応答・予算差異の可視化・レポート出力
- 含まない（初期版v1では除外/将来検討）:
  - OFX/QIF/TSVの取り込み
  - マルチプロフィール
  - バックアップ/復元
  - 監査ログ（詳細な監査・保持ポリシー）
  - 異常値検出

## 3. 用語

- 取引: 日付、金額、摘要、カテゴリ等を持つ家計記録
- 世帯: 単一または複数のメンバーで構成される家計単位
- MCPツール: MCPクライアントから呼び出される分析/操作インターフェース

## 4. 前提・制約

- すべての処理・保存は原則ローカル（オフライン動作前提）
- 日本円（JPY）のみを対象（多通貨は対象外）
- 入出力ファイルはローカルパス指定（入力はCSV）
- 個人情報は外部送信しない（ユーザーが明示的に許可しない限り）
- データ保存場所は data/ ディレクトリ配下

## 5. 機能要件（FR）

FR-001 取引データ取り込み

- ユーザーは CSV（カンマ区切り）のファイルから取引を取り込める
- 列マッピングをユーザーが指定・保存できる（テンプレート）
- 受入時にエンコーディングと日付形式を指定可能
- 受入時に重複判定を行う
受け入れ条件:
- サンプルCSVで1000件以上を正しく取り込める
- 列マッピングテンプレートを保存/再利用できる
- 重複が二重登録されない

FR-002 取引の正規化/検証

- 符号（支出はマイナス/プラスの取り扱い）と小数/通貨を正規化
- 日付/金額/必須フィールドの検証とエラー報告
受け入れ条件:
- 不正行は行番号と理由付きでレポートされる
- 正規化後の件数/合計が期待値と一致

FR-003 自動分類と手動上書き

- システムは取引をカテゴリへ自動分類（MoneyForward形式のカテゴリ/サブカテゴリ体系を採用）
- ユーザーは手動でカテゴリ修正・ルール追加が可能（優先）
受け入れ条件:
- 学習/ルール更新後、再分類で上書きが反映
- 自動分類精度の簡易レポートが取得可能（正解率、未分類率）

FR-004 対話的質問応答（MCP）

- 日本語で「先月の食費は？」「今期の固定費の内訳は？」等に回答
- フォローアップ（文脈）対応
受け入れ条件:
- 代表的質問10種に対し、数値/期間/カテゴリが正確
- コンテキストを跨ぐ2往復以上で意味整合が保たれる

FR-005 集計・分析

- 期間別/カテゴリ別/店舗（摘要）別/口座別の集計
- 月次トレンド、トップN支出
受け入れ条件:
- 指定期間・粒度（日/週/月/年）で数値が正しい

FR-006 予算管理

- サブカテゴリ別の月次予算の設定/編集/インポート
- 期首は月初（毎月1日）固定
- 実績との差異・達成率・警告（しきい値）提示
受け入れ条件:
- 達成率と差異が正しく計算・表示
- しきい値超過で警告フラグが返る

FR-007 レポート出力

- 集計結果をCSV/JSONとしてエクスポート
- レポートに期間・条件のメタ情報を付与
受け入れ条件:
- 指定ディレクトリに正しい形式・エンコーディングで保存

FR-008 タグ/メモ付与

- 取引に任意タグ・メモを付与・検索可能
受け入れ条件:
- タグでのフィルタと複合条件検索が機能

FR-009 重複検出・解決(拡張版)

FR-009-1 重複検出ロジック

- 日付と金額に基づく重複候補の検出
- 日付の誤差許容オプション（±N日、デフォルト: 0日=完全一致）
- 金額の誤差許容オプション:
  - 絶対値での誤差（±X円、デフォルト: 0円=完全一致）
  - 割合での誤差（±Y%、デフォルト: 0%=完全一致）
- 検出された重複候補ペアのリスト生成
- 摘要・カテゴリは重複判定基準に含めない(ユーザーの最終判断材料として提示のみ)

FR-009-2 ユーザー確認インターフェース(必須)

- 重複候補をMCPツール経由でユーザーに提示
- 各候補ペアの詳細情報を並べて表示:
  - 取引ID、日付、金額、摘要、カテゴリ、口座、メモ等
- ユーザーが各ペアに対して判定を入力:
  - 「重複である」/ 「重複でない」/ 「スキップ（保留）」
- 判定結果を取引レコードに記録

FR-009-3 データベースキャッシュと判定結果の永続化

- CSVから読み込んだ取引データをSQLiteデータベースにキャッシュ
- データベース配置場所: `data/household.db`
- 各取引レコードに以下のフィールドを追加:
  - `is_duplicate`: Boolean（重複フラグ、デフォルト: False）
  - `duplicate_of`: 参照先取引ID（どの取引の重複か）
  - `duplicate_checked`: Boolean（ユーザーが確認済みか）
  - `duplicate_checked_at`: タイムスタンプ（確認日時）
- ユーザーの判定結果をDBに保存し、以降の分析・レポートで活用

FR-009-4 重複解消アクション

- ユーザーが「重複である」と確認した取引に対して:
  - `is_duplicate=True`フラグを設定（論理削除）
  - 元データは保持（物理削除しない）
  - 重複フラグが立った取引は、デフォルトで集計・分析から除外
  - オプションで重複取引を含めた分析も可能（監査・検証用）
- 誤判定した場合の復元機能:
  - フラグをFalseに戻すことで復元可能
- 処理履歴をDBに記録(誰が、いつ、どの取引を重複と判定したか)

受け入れ条件:

- 同一ファイル再取り込みで、誤差オプション=0の場合に件数が増えない
- 誤差オプション指定時、指定範囲内の類似取引が重複候補として検出される
- ユーザーが重複候補を確認し、判定を記録できる
- 判定結果がDBに永続化され、再起動後も保持される
- 重複フラグが立った取引は、デフォルトの集計から除外される
- 重複フラグの解除（復元）が可能

FR-010 マルチプロフィール（将来）

- v1では非対応（単一プロファイル前提）
受け入れ条件:
- なし（将来対応時に定義）

FR-011 MCPツール群

- データ取り込み、クエリ集計、予算操作、レポート出力をツールとして公開
- 入力検証とエラーを日本語で返す
受け入れ条件:
- 主要操作が全てMCP経由で実行可能

FR-012 監査/ログ（将来）

- v1では不要（既定無効）。必要時に有効化できる設計とする（設計以降で方針化）
受け入れ条件:
- なし（将来対応時に定義）

FR-013 バックアップ/復元（将来）

- v1では提供しない
受け入れ条件:
- なし（将来対応時に定義）

FR-014 エラー/メッセージの日本語化

- すべてのユーザ向けメッセージは日本語で表示/返却
受け入れ条件:
- 代表エラーケースで自然な日本語が返る

FR-015 グラフ可視化機能

- 家計データをグラフ画像として生成・表示できる
- サポートするグラフタイプ:
  - 円グラフ（pie）: カテゴリ別支出割合
  - 棒グラフ（bar）: カテゴリ間比較
  - 折れ線グラフ（line）: 時系列トレンド
  - 面グラフ（area）: 累積トレンド
- 日本語テキスト（カテゴリ名、ラベル等）を正しくレンダリング
- 画像サイズの指定が可能（デフォルト: 800x600）
- 画像フォーマットの指定が可能（png, svg, jpg）
受け入れ条件:
- 全グラフタイプで日本語が正しく表示される
- MCPツール経由で画像URLまたは画像データが取得できる
- 指定した画像サイズ・フォーマットで出力される

FR-016 HTTP画像配信

- 生成した画像をHTTPエンドポイント経由で配信
- ストリーミング配信によるメモリ効率化
- 画像キャッシングによる高速レスポンス
- サポートエンドポイント:
  - `GET /api/charts/{chart_id}`: 画像取得
  - `GET /api/charts/{chart_id}/info`: 画像メタデータ
  - `GET /api/cache/stats`: キャッシュ統計
  - `DELETE /api/cache`: キャッシュクリア
  - `GET /health`: ヘルスチェック
受け入れ条件:
- HTTPエンドポイントから画像が正常に取得できる
- キャッシュヒット時のレスポンスが高速（< 0.1秒）
- 複数同時リクエストで安定動作

FR-017 MCPツールの画像生成対応

- 既存MCPツール（get_monthly_household, get_category_trend等）に画像生成オプションを追加
- `output_format` パラメータで出力形式を選択:
  - `"text"`: テキスト形式（デフォルト、従来通り）
  - `"image"`: 画像形式（URLを返却）
- 画像形式選択時の追加パラメータ:
  - `graph_type`: グラフタイプ
  - `image_size`: 画像サイズ
  - `image_format`: 画像フォーマット
受け入れ条件:
- テキスト形式と画像形式の両方が動作
- 画像形式選択時、画像URLが返却される
- 従来のテキスト形式の動作に影響がない

## 6. 非機能要件（NFR）

NFR-001 プライバシー: 既定で外部通信なし。明示許可時のみ外部送信
NFR-002 パフォーマンス: 取引10万件で主要クエリが2秒以内（ローカルSSD想定）
NFR-003 可用性: 単体ローカル運用で安定。異常終了時の再起動で整合性保持
NFR-004 セキュリティ: 保存データの暗号化はなし（v1）。OSユーザ権限で保護
NFR-005 画像生成性能: グラフ画像生成は3秒以内に完了
NFR-006 画像生成メモリ: 画像生成時のメモリ増分は50MB以内
NFR-007 移植性: Linuxのみで動作（x86_64/ARM64は環境に依存）
NFR-008 言語・通貨: 日本語のみ対応。通貨はJPY固定（多言語対応は不要）
NFR-009 保守性: 設定/データ/コードを分離。設定は人間可読（YAML/JSON）
NFR-010 監視性: v1では対象外（将来）
NFR-011 テスト性: サンプルデータセット/固定シナリオで再現可能
NFR-012 信頼性: 取り込み時のトランザクション性(部分失敗のロールバック/スキップ)
NFR-013 データ永続性: 重複判定結果はSQLiteで永続化。再起動後も保持
NFR-014 保守性（モジュール分離）: フロントエンドとバックエンドの責務を分離し、ディレクトリ構成・タスク定義・依存管理を独立させる
NFR-015 開発者体験（DX）: ルート/各パッケージのどちらからでも主要タスクを簡潔に実行できるよう統一化されたタスク/スクリプトを提供する

## 7. 受け入れテストシナリオ（抜粋）

TS-001 CSV取り込み正常系: マッピング適用→1000件登録→合計一致
TS-002 取り込み異常系: 不正日付/金額→行番号と理由を報告
TS-003 重複防止: 同一ファイル再取込→総件数不変
TS-003-1 重複検出(誤差なし): 日付・金額完全一致の取引ペアが検出される
TS-003-2 重複検出(日付誤差): ±1日、金額完全一致で候補検出
TS-003-3 重複検出(金額誤差): 日付完全一致、金額±10円または±1%で候補検出
TS-003-4 ユーザー確認: 重複候補の詳細表示→判定入力→DB保存
TS-003-5 重複フラグ: 重複と判定された取引が集計から除外される
TS-003-6 復元機能: 誤判定をフラグ解除で復元→集計に再度含まれる
TS-004 自動分類後の上書き: 手動修正→再分類→修正保持
TS-005 代表質問応答: 「先月の食費/固定費/収入合計/トップ3支出」回答の正確性
TS-006 予算差異: 予算設定→月次集計→差異/警告の一致
TS-007 レポート出力: 条件付CSV出力→内容とメタ一致
TS-008 バックアップ/復元: v1では対象外（将来）
TS-009 ローカル限定: ネットワーク遮断でも機能動作
TS-010 日本語エラーメッセージ: 代表エラーで自然な日本語
TS-011 画像生成: 全グラフタイプで日本語レンダリング正常→画像URL取得
TS-012 画像生成性能: 100カテゴリの円グラフ生成が3秒以内（NFR-005）
TS-013 画像生成メモリ: 大規模データセットで画像生成時のメモリ増分が50MB以内（NFR-006）
TS-014 HTTP画像配信: エンドポイント経由で画像取得→ストリーミング正常
TS-015 画像キャッシング: 同一パラメータでの2回目リクエストがキャッシュヒット→0.1秒以内
TS-016 並行画像生成: 5件同時リクエストでエラーなく完了
TS-017 リポジトリ分割（構成検証）: ルートに `backend/` と `frontend/` が存在し、両方のREADMEが更新済み
TS-018 ルート品質ゲート: ルートからAll Checks（フォーマット、Lint、型、セキュリティ、テスト）がグリーン
TS-019 バックエンド起動/テスト: `backend/` からAPIサーバ起動とpytestが成功
TS-020 フロントエンド配信: `frontend/` から静的配信（8080）が可能で主要ページが表示

## 8. エッジケース/例外

- 文字コード混在（UTF-8, Shift_JIS）
- 日付形式混在（YYYY/MM/DD, DD-MM-YYYY）
- 返金/払い戻し（負金額）、ゼロ金額
- 摘要のノイズ/絵文字/長文
- タイムゾーン跨ぎ月末処理
- 口座間振替（実質収支0）
- - 重複だが微差(メモのみ差異)
- 同日同額の複数取引(実際には別物、例:同じ店で朝夜に買い物)
- 多通貨・為替換算（v1対象外）
- 非常に大きい単発支出（異常値扱い）

## 9. 成功基準

- 代表シナリオ（TS-001〜TS-010）を再現可能
- 10万件規模で実用応答
- ローカルのみで一連の運用が完結

## 10. トレーサビリティ

- FRとTSを相互参照（例: FR-001 ↔ TS-001/002/003）

## 10.1. Webアプリケーション要件（FR-018）

FR-018 Webベースのインタラクティブ分析UI

- ユーザーはブラウザから家計簿データを可視化・操作できる
- HTTPサーバ経由でバックエンドAPIと通信する
- サーバー実装とは独立したフロントエンドとして管理する

受け入れ条件:

- 年月選択により月次データを表示できる
- 円グラフ・棒グラフ・折れ線グラフでデータを可視化できる
- データテーブルで取引明細を表示し、検索・フィルタリングできる
- 統計サマリー（総支出、取引件数、平均、最大）を表示できる
- モバイル・タブレット・PCで適切に表示される（レスポンシブデザイン）
- バックエンドAPIが利用できない場合にエラーメッセージを表示する

FR-018-1 REST APIエンドポイント

- `GET /api/monthly`: 月次データ取得（JSON形式）
- `GET /api/available-months`: 利用可能な年月リスト
- `GET /api/category-hierarchy`: カテゴリ階層情報
- 既存のチャート画像エンドポイント（`/api/charts/{chart_id}`）を活用

受け入れ条件:

- 各エンドポイントが適切なJSONレスポンスを返す
- エラー時にHTTPステータスコードとエラーメッセージを返す
- CORS設定により異なるポートからのアクセスを許可する

FR-018-2 フロントエンド実装

- Vanilla JavaScript（ES6+）でSPA風のUIを実装
- Chart.jsによるインタラクティブなグラフ表示
- 非同期通信によるスムーズなデータ読み込み
- ローディングインジケーターとエラーハンドリング

受け入れ条件:

- 外部フレームワークに依存しない（Vanilla JS + Chart.js CDN）
- XSS対策が施されている
- ブラウザコンソールにエラーが出ない

FR-019 収支トレンド可視化機能

- ユーザーは複数月の収支推移をグラフで可視化できる
- 期間を指定して月次トレンドを表示する
- カテゴリ別の推移を確認できる
- プリセット期間（直近3/6/12ヶ月、全期間）で素早く表示できる

受け入れ条件:

- 開始年月〜終了年月を選択して期間指定できる
- 月次推移（収入・支出・収支差額）を折れ線グラフで表示できる
- 累積収支を折れ線グラフで表示できる
- カテゴリ別トレンドを積み上げグラフで表示できる
- プリセットボタン（直近3ヶ月、6ヶ月、12ヶ月、全期間）で期間を素早く設定できる
- デフォルト表示は直近3ヶ月
- タブでグラフ種類を切り替えられる

FR-019-1 トレンド分析APIエンドポイント

- `GET /api/trend/monthly_summary`: 期間指定で月次収支サマリーを取得
  - パラメータ: start_year, start_month, end_year, end_month
  - レスポンス: 月別の収入・支出・収支差額・累積収支のリスト
- `GET /api/trend/category_breakdown`: 期間指定でカテゴリ別推移を取得
  - パラメータ: start_year, start_month, end_year, end_month, top_n（デフォルト5）
  - レスポンス: 主要カテゴリの月次推移データ

受け入れ条件:

- 期間パラメータが正しく処理される
- データが存在しない月は0として返される
- エラー時に適切なHTTPステータスとメッセージを返す

FR-019-2 トレンドUI実装

- メインページにタブUIを追加（「月次分析」「トレンド分析」）
- 期間選択UI（年月ドロップダウン × 2 + プリセットボタン）
- 複数のトレンドグラフをタブで切り替え表示
- グラフ切り替えタブ（「月次推移」「累積収支」「カテゴリ別」）

受け入れ条件:

- タブ切り替えがスムーズに動作する
- グラフが見やすく表示される
- 期間選択が直感的に操作できる
- プリセットボタンで即座に期間が設定される
- レスポンシブデザインが維持される

## 10.2. リポジトリ構成分割（FR-020）

FR-020 フロントエンド/バックエンド分割とモノレポ構成

- リポジトリをフロントエンド（web UI）とバックエンド（MCPサーバ/API）に分割し、トップレベルに以下のディレクトリを配置する
  - `backend/`（Python: MCPサーバ、API、ライブラリ、テスト、ドキュメント）
  - `frontend/`（Webアプリ: 静的アセット、ビルド設定、テスト、ドキュメント）
  - `shared/`（任意・将来）：スキーマ/定数/ドキュメントの共有領域（当面は空でも可）
- 既存の `src/`、`tests/`、`docs/` 等は新構成へ移設する
- ルートには開発者向けのメタファイルのみを残す（例: README、リポジトリ全体のガイド、Makefile/タスク）
- タスク実行・サーバ起動・テスト実行は、ルートと各パッケージ（backend/frontend）いずれからも実行できる
- CI/品質ゲート（フォーマット、Lint、型、セキュリティ、テスト）が新構成でグリーンになる

受け入れ条件:

- ルート直下に `backend/` と `frontend/` が存在し、それぞれにREADMEがある
- 既存のPythonコード（MCPサーバ、API）は `backend/` 配下へ移動し、`uv run pytest` でテストが成功する
- 既存のWeb静的ファイルは `frontend/` 配下へ移動し、`python -m http.server 8080` 等で配信できる（暫定で可）
- ルートの開発タスク（フォーマット、Lint、型、セキュリティ、テスト、サーバ起動）が新構成に追従して動作する
- 既存のドキュメントとスクリプトの参照パスが更新されている（リンク切れがない）
- Start Full Webapp Stack 相当の開発体験（API サーバ + フロントエンド）が維持される
- READMEとdocsに新しい構成が図解/記述されている

## 11. MCP ツール実行フロントエンド機能（FR-021）

FR-021 手動 MCP ツール実行UIの実装

概要：

- フロントエンドで利用可能なMCPツール（get_monthly_household, get_category_trend, detect_duplicates等）をギャラリー形式で表示し、ユーザーが各ツールを手動実行できるページを追加する

要件詳細：

1. **ページ構成**
   - 現在のメインページ（月次分析・トレンド分析タブ）とは独立した新ページを作成する
   - トップページ（index.html）に「MCPツール実行」への分岐リンクを追加
   - 新ページを `mcp-tools.html` として実装

2. **ツール一覧表示（ギャラリー形式）**
   - MCPツール一覧ページでは、API経由で利用可能なツール定義を取得
   - 各ツール1枚のカード（Card UI）で表示
   - カード内容：
     - ツール名（日本語/英語）
     - ツール説明/用途
     - 必須パラメータ一覧
     - オプションパラメータ一覧
     - 「このツールを実行」ボタン

3. **ツール実行フロー**
   - ユーザーがカードの「実行」ボタンをクリック → モーダルダイアログで入力フォーム表示
   - パラメータ型に応じた入力フィールド生成（文字列、数値、日付、選択肢等）
   - デフォルト値があれば自動入力
   - 実行ボタン → HTTP API (POST /api/tools/{tool_name}/execute) でバックエンドに送信
   - 実行結果をモーダルに表示（テキスト/テーブル/グラフ等）

4. **バックエンド API設計**
   - `GET /api/tools` - 利用可能なツール一覧と定義を返す
   - `GET /api/tools/{tool_name}` - 指定ツールの詳細定義を返す
   - `POST /api/tools/{tool_name}/execute` - ツール実行（パラメータをJSON本体で受け取り）

5. **対応ツール（初期版）**
   - `get_monthly_household`: 月次取引明細の取得
   - `get_category_trend`: カテゴリ別トレンド分析
   - `detect_duplicates`: 重複候補検出
   - `get_duplicate_candidates`: 未判定の重複候補取得
   - `confirm_duplicate`: 重複判定の記録
   - 将来: `restore_duplicate`, `get_duplicate_stats` 等

受け入れ条件:

- `mcp-tools.html` が作成され、アクセス可能（トップページからのリンク）
- ギャラリーに5個以上のツールカードが表示される
- 各カードにツール名、説明、パラメータが明示されている
- 「このツールを実行」をクリックするとモーダルで入力フォームが表示される
- パラメータ入力後に「実行」をクリックすると、HTTP APIで バックエンドにリクエストが送信される
- 結果がモーダルに表示される（成功時：テキスト/テーブル、エラー時：エラーメッセージ）
- `/api/tools` と `/api/tools/{tool_name}` エンドポイントが動作する
- `/api/tools/{tool_name}/execute` エンドポイントが動作する
- レスポンシブデザインが維持される

## 12. 決定事項（Q1〜Q10反映）

- Q1: 入力はCSVを優先（v1はCSVのみ対応）
- Q2: 通貨はJPYのみ
- Q3: プロファイルは単一想定（マルチは将来）
- Q4: カテゴリ体系はMoneyForward形式を採用
- Q5: 予算はサブカテゴリ粒度、期首は月初固定
- Q6: MCPクライアントはテキスト対話のみでOK
- Q7: 保存場所は data/、バックアップなし、暗号化なし
- Q8: ログ保持は不要（監査ログは将来）
- Q9: 異常値検出は現時点で検討不要（将来）
- Q10: 対応OSはLinuxのみ

## 13. 承認記録

### FR-018: Webベースのインタラクティブ分析UI

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-01
- **概要**: ブラウザベースのWebアプリケーションにより、家計データを可視化・操作するUI を実装。REST APIエンドポイント と Vanilla JS + Chart.js によるフロントエンドで構成
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（frontend/ に統合済み）

### FR-019: 収支トレンド可視化機能

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-01
- **概要**: 複数月の収支推移をグラフで可視化するトレンド分析UIを実装。期間指定・プリセット・複数グラフ形式に対応
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（frontend/index.html のトレンドタブに統合済み）

### FR-020: フロントエンド/バックエンド分割とモノレポ構成

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-02
- **概要**: リポジトリを backend/ と frontend/ に分割し、モノレポ構成を採用。各パッケージの独立性と統合性を両立
- **受け入れ条件**: 全て明記済み
- **次ステップ**: 実装完了（ディレクトリ構成・CI/CD・ドキュメント整備済み）

### FR-021: MCP ツール実行フロントエンド機能

- **ステータス**: ✅ 承認済み
- **承認日**: 2025-11-04
- **概要**: フロントエンドで利用可能なMCPツールをギャラリー形式で表示し、ユーザーが各ツールを手動で実行できるUIを実装
- **受け入れ条件**: 全て明記済み
- **次ステップ**: design.md での技術設計に進む

---

## 全体承認ステータス

本ドキュメントに記載された全要件（FR-001〜FR-021, NFR-001〜NFR-015）は承認済みです。
