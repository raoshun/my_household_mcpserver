# 家計簿分析 MCP サーバー タスク計画

- **バージョン**: 0.2.0
- **更新日**: 2025-10-03
- **対象設計**: [design.md](./design.md)
- **対象要件**: FR-001〜FR-003, NFR-001〜NFR-004

---

## フェーズ0: 既存基盤の棚卸し (Day 1)

- [x] **TASK-000**: 現行コード/データの確認
  - [x] `src/server.py` の既存 MCP リソース/ツールの挙動を確認（FR-001）
  - [x] `data/` 配下 CSV の構造と列揺れの差異を棚卸し（FR-001）
  - [x] 既存ユーティリティの再利用可否を評価（NFR-003）
    - DataLoader リファクタ & クラス化済み
    - レガシー `validators.py` / `data_tools.py` 削除済み（クリーンアップ）

---

## フェーズ1: インフラ・ユーティリティ整備 (Week 1)

- [x] **TASK-101**: 例外クラスとロギング基盤の整備（NFR-003）
  - [x] `src/household_mcp/exceptions.py` を新設し、`HouseholdMCPError`, `ValidationError`, `DataSourceError`, `AnalysisError` 実装
  - [ ] ログフォーマッタ設定（未着手 / ロギング extra に移行予定）

- [x] **TASK-102**: データ読み込みユーティリティの強化（FR-001, NFR-002）
  - [x] 列名マッピングと Categorical 型設定を実装（`_normalize_columns`）
  - [x] バルク読み込みヘルパー `load_many` 追加
  - [x] 欠損/対象外フィルタリング実装（`_post_process`）
  - [x] 月次キャッシュ + mtime 検知機構追加（拡張: `cache_stats` / hits & misses）

- [x] **TASK-103**: フォーマットユーティリティの追加（NFR-001）
  - [x] `format_currency`, `format_percentage`, 集計レスポンス整形関数実装
  - [x] 例外ハンドリングによるフォールバック（`format_percentage` の NaN → N/A）

- [x] **TASK-104**: クエリ解析ユーティリティの追加（FR-002, FR-003）
  - [x] `resolve_trend_query` による期間 & カテゴリ解釈
  - [x] 利用可能月のソート/キー化ユーティリティ
  - [x] 検証失敗時 `ValidationError` 送出を確認

---

## フェーズ2: トレンド分析コア実装 (Week 2)

- [ ] **TASK-201**: `CategoryTrendAnalyzer` の実装（FR-001, NFR-002）
  - [ ] `src/household_mcp/analysis/trends.py` を新設
  - [ ] 月次支出集計 + 指標（前月比/前年比/12か月移動平均）の計算
  - [ ] データ不足時の `AnalysisError` ハンドリング

- [ ] **TASK-202**: トレンド結果キャッシュ（NFR-002, NFR-003）
  - [ ] 分析結果を `functools.lru_cache` 等でメモ化
  - [ ] CSV 更新検知（ファイル更新時のキャッシュ無効化ポリシー）を実装

- [ ] **TASK-203**: レスポンスフォーマットの整備（FR-003, NFR-001）
  - [ ] `TrendResponseFormatter` でランキング/注釈テキストを生成
  - [ ] データ不足メッセージや N/A 表記の統一化

---

## フェーズ3: MCP リソース・ツール追加 (Week 3)

- [ ] **TASK-301**: `data://category_trend_summary` リソース実装（FR-001）
  - [ ] 直近 12 か月の指標サマリ辞書を返却
  - [ ] リクエスト毎に最新データを判定し、キャッシュ利用を制御

- [ ] **TASK-302**: `get_category_trend` ツール実装（FR-002, FR-003）
  - [ ] 入力検証〜解析〜フォーマットまでのオーケストレーションを構築
  - [ ] カテゴリ未指定時に上位カテゴリを返すフォールバックを実装
  - [ ] MCP エラーレスポンスの整備（NFR-003）

- [ ] **TASK-303**: サーバー登録処理の更新（FR-001〜FR-003）
  - [ ] `src/server.py` で新リソース/ツールを登録
  - [ ] 既存リソースドキュメントの整合性確認

---

## フェーズ4: テスト & 品質ゲート (Week 4)

- [ ] **TASK-401**: 単体テスト追加（TS-001〜TS-006）
  - [ ] `tests/unit/test_dataloader.py` に読み込みケースを追加
  - [ ] `tests/unit/analysis/test_trends.py` で指標計算結果を検証
  - [ ] `tests/unit/tools/test_get_category_trend.py` で入力バリエーションを網羅

- [ ] **TASK-402**: 統合テスト整備（TS-007〜TS-009）
  - [ ] `tests/integration/test_trend_pipeline.py` で E2E フローを検証
  - [ ] データ不足・カテゴリ未指定などのエッジケース確認

- [ ] **TASK-403**: 自動化と品質ゲート（NFR-002, NFR-003）
  - [ ] CI で `uv run pytest` を実行するワークフローを準備
  - [ ] 主要関数に型ヒントと docstring を追加

### 追加テスト進捗
- [x] DataLoader キャッシュ差分テスト (`test_cache_behaviour`)
- [x] キャッシュ統計テスト (`test_loader_cache_stats`) 追加（ヒット/ミス/リセット）
- [x] 異常系（欠損列/カテゴリ欠如/無効ディレクトリ）テスト拡張

---

## フェーズ5: ドキュメント & 運用準備 (Week 5)

- [ ] **TASK-501**: ドキュメント更新
  - [ ] `README.md` にトレンド分析ツールの利用方法を追記
  - [ ] `requirements.md` / `design.md` の変更点を CHANGELOG に連携

- [ ] **TASK-502**: サンプル会話・FAQ 整備
  - [ ] LLM クライアント向けのプロンプト例を追加
  - [ ] 発生しやすいエラーと対処法のまとめ

- [ ] **TASK-503**: 検収手順の確立
  - [ ] UAT チェックリストを作成し、受入条件に紐付け
  - [ ] デモ用シナリオデータの準備

---

## マイルストーン確認

| マイルストーン | 目標週 | 完了条件                                                             |
| -------------- | ------ | -------------------------------------------------------------------- |
| MS-1           | Week 1 | データ読み込み/フォーマットユーティリティの整備完了（TASK-101〜104） |
| MS-2           | Week 2 | トレンド分析コアとキャッシュ機構が動作（TASK-201〜203）              |
| MS-3           | Week 3 | 新リソース/ツールが MCP 経由で利用可能（TASK-301〜303）              |
| MS-4           | Week 4 | 単体・統合テストがグリーン（TASK-401〜403）                          |
| MS-5           | Week 5 | ドキュメントと UAT 手順が揃い受入準備完了（TASK-501〜503）           |

---

## チェックリスト (継続)

- [ ] CSV 更新時のキャッシュ無効化が想定通り動くか定期的に確認（NFR-002）
- [ ] 数値フォーマット仕様の一貫性を維持（NFR-001）
- [ ] 例外メッセージがユーザーにとって分かりやすいかレビュー（NFR-003）
- [ ] データはすべてローカル処理で完結しているか確認（NFR-004）

---

## 追加タスク（メンテナンス / 改善）

- [ ] **TASK-M01**: 依存最小化ポリシー文書化（README に optional extras 追記）
- [ ] **TASK-M02**: `logging` extra 選択時の構成ヘルパー追加（structlog 初期化）
- [ ] **TASK-M03**: Analyzer 側キャッシュ統計インターフェース統一 (`CategoryTrendAnalyzer.cache_stats`) 追加
- [ ] **TASK-M04**: 例外メッセージ多言語方針（現在: 日/英 混在）整理
- [ ] **TASK-M05**: CI ワークフロー (lint + test + coverage) 追加

---

## 進捗ログ

| 日付       | 内容                                                                 |
| ---------- | -------------------------------------------------------------------- |
| 2025-10-03 | DataLoader リファクタ・例外統一・追加カバレッジテスト                |
| 2025-10-04 | レガシーコード削除 / 依存最小化 / キャッシュ統計追加 / tasks.md 更新 |

---

# Household Budget Analysis MCP Server - 実装計画（tasks.md）
- バージョン: v1.1
- 日付: 2025-10-12
- 作成者: GitHub Copilot
- ステージ: Stage 3（Implementation Planning）/ 承認済
- 参照: ./requirements.md（v1.0）, ./design.md（v1.0, 承認済）

## 変更履歴
- v1.1: 旧Python系/画像生成/HTTPストリーミングの計画を削除し、設計v1.0（Node.js/TS）へ整合
- v1.0: 初版（要件v1.0/設計v1.0に準拠）

## 0. 方針と範囲
- 対応FR: 001,002,003,004,005,006,007,008,009,011,014（010/012/013は将来）
- 対応TS: 001,002,003,004,005,006,007,009,010（008は対象外）
- 対応OS: Linux、入力: CSVのみ、通貨: JPY、プロファイル: 単一
- 技術: Node.js 20+ / TypeScript, SQLite(better-sqlite3), MCP SDK, pino, csv-parse

## 1. マイルストーン
- M1: プロジェクト基盤/DBスキーマ確立
- M2: CSV取り込み/正規化/重複除外（FR-001/002/009, TS-001/002/003）
- M3: 自動分類/ルール（FR-003, TS-004）
- M4: 集計/検索/予算/レポート（FR-004/005/006/007/008, TS-005/006/007）
- M5: MCPツール公開/日本語エラー（FR-011/014, TS-010/全般）
- M6: E2E/性能確認（TS-001〜007/009/010, NFR-002）

## 2. タスク一覧（チェックリスト）
- [ ] T1: リポジトリ初期化と基盤
  - 内容: Node.js/TS設定、lint/format、pino、dotenv、ディレクトリ構成（src/, data/, fixtures/）
  - 依存: なし / 見積: 0.5d
  - 完了基準: ビルド・実行・ロガー起動

- [ ] T2: SQLite層とマイグレーション
  - 内容: better-sqlite3接続、FTS5有効化、マイグレーション仕組み、スキーマ作成（design.md §4）
  - 依存: T1 / 見積: 1.0d
  - 完了基準: DB初期化コマンドでテーブル/インデックス作成

- [ ] T3: I18n/Errorサービス
  - 内容: 日本語メッセージ定義、標準化エラー形（{code,message,details}）、入力検証ヘルパ
  - 依存: T1 / 見積: 0.5d
  - 完了基準: 代表エラーで自然な日本語返却（TS-010）

- [ ] T4: CSVマッピングテンプレート（FR-001）
  - 内容: テンプレ保存/取得、date_format/encoding保持
  - 依存: T2,T3 / 見積: 0.5d
  - 完了基準: 保存/取得APIのユニットテスト

- [ ] T5: 取り込み/正規化/検証（FR-001/002）
  - 内容: csv-parseストリーム、マッピング適用、日付/金額正規化、行エラー収集
  - 依存: T2,T3,T4 / 見積: 1.5d
  - 完了基準: TS-001/002合格

- [ ] T6: 重複検出/除外（FR-009）
  - 内容: 正規化ハッシュ生成（design.mdの規約）、UNIQUE制約でskip、結果レポート
  - 依存: T5 / 見積: 0.5d
  - 完了基準: TS-003合格

- [ ] T7: 分類ルールエンジン（FR-003）
  - 内容: priority/substring|regex|exact評価、最初一致採用、未分類はNULL
  - 依存: T2 / 見積: 1.0d
  - 完了基準: 代表ケースで正しくカテゴリが付与

- [ ] T8: 手動上書き/ルール追加（FR-003）
  - 内容: add_category_ruleツール、再分類で反映、簡易メトリクス（未分類率）
  - 依存: T7 / 見積: 0.5d
  - 完了基準: TS-004合格

- [ ] T9: 集計/検索（FR-004/005/008）
  - 内容: 粒度（日/週/月/年）集計、トップN、全文検索（FTS5）、タグ付与/除去/検索
  - 依存: T2,T5 / 見積: 1.5d
  - 完了基準: 代表クエリの数値一致、タグ検索動作

- [ ] T10: 予算（FR-006）
  - 内容: set_budget/get_budget_status、差異/達成率/警告計算
  - 依存: T2,T9 / 見積: 0.5d
  - 完了基準: TS-006合格

- [ ] T11: レポート出力（FR-007）
  - 内容: aggregate/transactionsのCSV/JSON出力、メタ付与、UTF-8
  - 依存: T9 / 見積: 0.5d
  - 完了基準: TS-007合格

- [ ] T12: MCPサーバ/ツール公開（FR-011/014）
  - 内容: @modelcontextprotocol/sdk設定、各ツール導線、JSON Schema検証、日本語エラー
  - 依存: T3,T4,T5,T6,T7,T8,T9,T10,T11 / 見積: 1.0d
  - 完了基準: 主要操作がMCP経由で実行可能（FR-011受入）

- [ ] T13: E2Eと性能（NFR-002, TS-001〜007/009/010）
  - 内容: fixtures準備、シナリオ自動化、10万件相当の性能確認
  - 依存: T12 / 見積: 1.0d
  - 完了基準: 全対象TS合格、主要クエリ<2秒

## 3. 依存関係（要約）
- T1 → T2 →（T4,T3）→ T5 → T6
- T2 → T7 → T8
- T2 → T9 →（T10, T11）
- すべての機能タスク → T12 → T13

## 4. 工数見積（合計の目安）
- 約 10.0 人日（小規模調整含む）

## 5. トレーサビリティ
- FR-001/002/009 ↔ T4/T5/T6, TS-001/002/003
- FR-003 ↔ T7/T8, TS-004
- FR-004/005/008 ↔ T9, TS-005
- FR-006 ↔ T10, TS-006
- FR-007 ↔ T11, TS-007
- FR-011/014 ↔ T12, TS-010
- NFR-002 ↔ T13

## 6. 完了条件（リリース基準）
- TS-001〜007/009/010 合格、NFR-002満たす
- 主要ツールの日本語エラー/I18n整備、ローカルのみで一連の運用が完結
