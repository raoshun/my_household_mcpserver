# 家計簿分析 MCP サーバー タスク計画

- **バージョン**: 0.2.0
- **更新日**: 2025-10-03
- **対象設計**: [design.md](./design.md)
- **対象要件**: FR-001〜FR-003, NFR-001〜NFR-004

---

## フェーズ0: 既存基盤の棚卸し (Day 1)

- [x] **TASK-000**: 現行コード/データの確認
  - [x] `src/server.py` の既存 MCP リソース/ツールの挙動を確認（FR-001）
  - [x] `data/` 配下 CSV の構造と列揺れの差異を棚卸し（FR-001）
  - [x] 既存ユーティリティの再利用可否を評価（NFR-003）
    - DataLoader リファクタ & クラス化済み
    - レガシー `validators.py` / `data_tools.py` 削除済み（クリーンアップ）

---

## フェーズ1: インフラ・ユーティリティ整備 (Week 1)

- [x] **TASK-101**: 例外クラスとロギング基盤の整備（NFR-003）
  - [x] `src/household_mcp/exceptions.py` を新設し、`HouseholdMCPError`, `ValidationError`, `DataSourceError`, `AnalysisError` 実装
  - [ ] ログフォーマッタ設定（未着手 / ロギング extra に移行予定）

- [x] **TASK-102**: データ読み込みユーティリティの強化（FR-001, NFR-002）
  - [x] 列名マッピングと Categorical 型設定を実装（`_normalize_columns`）
  - [x] バルク読み込みヘルパー `load_many` 追加
  - [x] 欠損/対象外フィルタリング実装（`_post_process`）
  - [x] 月次キャッシュ + mtime 検知機構追加（拡張: `cache_stats` / hits & misses）

- [x] **TASK-103**: フォーマットユーティリティの追加（NFR-001）
  - [x] `format_currency`, `format_percentage`, 集計レスポンス整形関数実装
  - [x] 例外ハンドリングによるフォールバック（`format_percentage` の NaN → N/A）

- [x] **TASK-104**: クエリ解析ユーティリティの追加（FR-002, FR-003）
  - [x] `resolve_trend_query` による期間 & カテゴリ解釈
  - [x] 利用可能月のソート/キー化ユーティリティ
  - [x] 検証失敗時 `ValidationError` 送出を確認

---

## フェーズ2: トレンド分析コア実装 (Week 2)

- [ ] **TASK-201**: `CategoryTrendAnalyzer` の実装（FR-001, NFR-002）
  - [ ] `src/household_mcp/analysis/trends.py` を新設
  - [ ] 月次支出集計 + 指標（前月比/前年比/12か月移動平均）の計算
  - [ ] データ不足時の `AnalysisError` ハンドリング

- [ ] **TASK-202**: トレンド結果キャッシュ（NFR-002, NFR-003）
  - [ ] 分析結果を `functools.lru_cache` 等でメモ化
  - [ ] CSV 更新検知（ファイル更新時のキャッシュ無効化ポリシー）を実装

- [ ] **TASK-203**: レスポンスフォーマットの整備（FR-003, NFR-001）
  - [ ] `TrendResponseFormatter` でランキング/注釈テキストを生成
  - [ ] データ不足メッセージや N/A 表記の統一化

---

## フェーズ3: MCP リソース・ツール追加 (Week 3)

- [ ] **TASK-301**: `data://category_trend_summary` リソース実装（FR-001）
  - [ ] 直近 12 か月の指標サマリ辞書を返却
  - [ ] リクエスト毎に最新データを判定し、キャッシュ利用を制御

- [ ] **TASK-302**: `get_category_trend` ツール実装（FR-002, FR-003）
  - [ ] 入力検証〜解析〜フォーマットまでのオーケストレーションを構築
  - [ ] カテゴリ未指定時に上位カテゴリを返すフォールバックを実装
  - [ ] MCP エラーレスポンスの整備（NFR-003）

- [ ] **TASK-303**: サーバー登録処理の更新（FR-001〜FR-003）
  - [ ] `src/server.py` で新リソース/ツールを登録
  - [ ] 既存リソースドキュメントの整合性確認

---

## フェーズ4: テスト & 品質ゲート (Week 4)

- [ ] **TASK-401**: 単体テスト追加（TS-001〜TS-006）
  - [ ] `tests/unit/test_dataloader.py` に読み込みケースを追加
  - [ ] `tests/unit/analysis/test_trends.py` で指標計算結果を検証
  - [ ] `tests/unit/tools/test_get_category_trend.py` で入力バリエーションを網羅

- [ ] **TASK-402**: 統合テスト整備（TS-007〜TS-009）
  - [ ] `tests/integration/test_trend_pipeline.py` で E2E フローを検証
  - [ ] データ不足・カテゴリ未指定などのエッジケース確認

- [ ] **TASK-403**: 自動化と品質ゲート（NFR-002, NFR-003）
  - [ ] CI で `uv run pytest` を実行するワークフローを準備
  - [ ] 主要関数に型ヒントと docstring を追加

### 追加テスト進捗
- [x] DataLoader キャッシュ差分テスト (`test_cache_behaviour`)
- [x] キャッシュ統計テスト (`test_loader_cache_stats`) 追加（ヒット/ミス/リセット）
- [x] 異常系（欠損列/カテゴリ欠如/無効ディレクトリ）テスト拡張

---

## フェーズ5: ドキュメント & 運用準備 (Week 5)

- [ ] **TASK-501**: ドキュメント更新
  - [ ] `README.md` にトレンド分析ツールの利用方法を追記
  - [ ] `requirements.md` / `design.md` の変更点を CHANGELOG に連携

- [ ] **TASK-502**: サンプル会話・FAQ 整備
  - [ ] LLM クライアント向けのプロンプト例を追加
  - [ ] 発生しやすいエラーと対処法のまとめ

- [ ] **TASK-503**: 検収手順の確立
  - [ ] UAT チェックリストを作成し、受入条件に紐付け
  - [ ] デモ用シナリオデータの準備

---

## マイルストーン確認

| マイルストーン | 目標週 | 完了条件                                                             |
| -------------- | ------ | -------------------------------------------------------------------- |
| MS-1           | Week 1 | データ読み込み/フォーマットユーティリティの整備完了（TASK-101〜104） |
| MS-2           | Week 2 | トレンド分析コアとキャッシュ機構が動作（TASK-201〜203）              |
| MS-3           | Week 3 | 新リソース/ツールが MCP 経由で利用可能（TASK-301〜303）              |
| MS-4           | Week 4 | 単体・統合テストがグリーン（TASK-401〜403）                          |
| MS-5           | Week 5 | ドキュメントと UAT 手順が揃い受入準備完了（TASK-501〜503）           |

---

## チェックリスト (継続)

- [ ] CSV 更新時のキャッシュ無効化が想定通り動くか定期的に確認（NFR-002）
- [ ] 数値フォーマット仕様の一貫性を維持（NFR-001）
- [ ] 例外メッセージがユーザーにとって分かりやすいかレビュー（NFR-003）
- [ ] データはすべてローカル処理で完結しているか確認（NFR-004）

---

## 追加タスク（メンテナンス / 改善）

- [ ] **TASK-M01**: 依存最小化ポリシー文書化（README に optional extras 追記）
- [ ] **TASK-M02**: `logging` extra 選択時の構成ヘルパー追加（structlog 初期化）
- [ ] **TASK-M03**: Analyzer 側キャッシュ統計インターフェース統一 (`CategoryTrendAnalyzer.cache_stats`) 追加
- [ ] **TASK-M04**: 例外メッセージ多言語方針（現在: 日/英 混在）整理
- [ ] **TASK-M05**: CI ワークフロー (lint + test + coverage) 追加

---

## 進捗ログ

| 日付       | 内容                                                                 |
| ---------- | -------------------------------------------------------------------- |
| 2025-10-03 | DataLoader リファクタ・例外統一・追加カバレッジテスト                |
| 2025-10-04 | レガシーコード削除 / 依存最小化 / キャッシュ統計追加 / tasks.md 更新 |

---

## フェーズ6: 画像生成機能実装 (Week 6)

- [ ] **TASK-601**: 画像生成基盤の整備（FR-004, NFR-005）
  - [ ] `src/household_mcp/visualization/chart_generator.py` 新設
  - [ ] matplotlib 設定とChartGeneratorクラス実装
  - [ ] 日本語フォント自動検出機能(`_detect_japanese_font`)実装
  - [ ] 基本グラフタイプ（pie, bar, line, area）の生成メソッド実装
  - **推定工数**: 2日
  - **依存関係**: matplotlib, pillow パッケージ追加

- [ ] **TASK-602**: グラフスタイル・配色設定（NFR-007）
  - [ ] `src/household_mcp/visualization/styles.py` 新設
  - [ ] カテゴリ別配色パレット定義
  - [ ] matplotlib rcParams 設定（フォントサイズ、DPI等）
  - [ ] 視認性の高いグラフスタイル実装
  - **推定工数**: 1日
  - **依存関係**: TASK-601

- [ ] **TASK-603**: 画像生成テスト（TS-010, TS-011）
  - [ ] `tests/unit/test_chart_generator.py` 新設
  - [ ] 各グラフタイプの生成テスト
  - [ ] 画像サイズ・形式の検証テスト
  - [ ] エラーハンドリング（ChartGenerationError）テスト
  - **推定工数**: 1.5日
  - **依存関係**: TASK-601, TASK-602

---

## フェーズ7: HTTPストリーミング実装 (Week 7)

- [ ] **TASK-701**: HTTPサーバー基盤の実装（FR-005, NFR-006）
  - [ ] `src/household_mcp/server/http_server.py` 新設
  - [ ] FastAPI アプリケーション設定
  - [ ] 画像ストリーミングエンドポイント実装
  - [ ] 非同期チャンクストリーミング機能実装
  - **推定工数**: 2日
  - **依存関係**: FastAPI, uvicorn パッケージ追加

- [ ] **TASK-702**: 画像キャッシュシステム実装（NFR-006）
  - [ ] `src/household_mcp/streaming/cache.py` 新設
  - [ ] TTLCache による画像キャッシュ実装
  - [ ] キャッシュキー生成・管理機能
  - [ ] メモリ使用量制限・クリーンアップ機能
  - **推定工数**: 1.5日
  - **依存関係**: cachetools パッケージ追加

- [ ] **TASK-703**: 画像ストリーマー実装（FR-005）
  - [ ] `src/household_mcp/streaming/image_streamer.py` 新設
  - [ ] 画像データの分割ストリーミング機能
  - [ ] エラーハンドリング・リトライ機能
  - [ ] Content-Type ヘッダー自動設定
  - **推定工数**: 1.5日
  - **依存関係**: TASK-701, TASK-702

- [ ] **TASK-704**: HTTPストリーミングテスト（TS-013, TS-014, TS-015）
  - [ ] `tests/unit/test_image_streamer.py` 新設
  - [ ] `tests/integration/test_streaming_pipeline.py` 新設
  - [ ] チャンク分割・転送速度テスト
  - [ ] エラー処理・リトライ機能テスト
  - [ ] 同時接続数テスト
  - **推定工数**: 2日
  - **依存関係**: TASK-701, TASK-702, TASK-703

---

## フェーズ8: MCPツール拡張実装 (Week 8)

- [ ] **TASK-801**: 既存ツール引数拡張（FR-006）
  - [ ] `src/household_mcp/tools/enhanced_tools.py` 新設
  - [ ] `get_monthly_household`, `get_category_trend` の引数拡張
  - [ ] `output_format`, `graph_type`, `image_size` パラメータ追加
  - [ ] 後方互換性維持機能実装
  - **推定工数**: 1.5日
  - **依存関係**: TASK-601, TASK-701

- [ ] **TASK-802**: ツールルーティング実装（FR-006）
  - [ ] テキスト/画像出力の分岐処理実装
  - [ ] 画像生成→キャッシュ→URL生成フロー実装
  - [ ] フォールバック処理（画像生成失敗時テキスト出力）
  - **推定工数**: 1.5日
  - **依存関係**: TASK-801

- [ ] **TASK-803**: 設定・環境変数管理（NFR-008）
  - [ ] `src/household_mcp/config.py` に StreamingConfig 追加
  - [ ] 環境変数による設定オーバーライド機能
  - [ ] 設定検証・デフォルト値設定
  - **推定工数**: 0.5日
  - **依存関係**: TASK-801, TASK-802

- [ ] **TASK-804**: MCPツール拡張テスト（TS-016, TS-017, TS-018）
  - [ ] `tests/unit/tools/test_enhanced_tools.py` 新設
  - [ ] 引数拡張・後方互換性テスト
  - [ ] ルーティング・フォールバック処理テスト
  - [ ] 無効引数・エラーハンドリングテスト
  - **推定工数**: 2日
  - **依存関係**: TASK-801, TASK-802, TASK-803

---

## フェーズ9: 統合・品質保証 (Week 9)

- [ ] **TASK-901**: エンドツーエンド統合テスト
  - [ ] 既存テストスイートとの統合
  - [ ] 画像生成→ストリーミング→配信の全フロー検証
  - [ ] パフォーマンステスト（3秒以内生成、1MB/秒転送）
  - [ ] メモリ使用量テスト（50MB制限確認）
  - **推定工数**: 2日
  - **依存関係**: TASK-603, TASK-704, TASK-804

- [ ] **TASK-902**: セキュリティ・安定性検証
  - [ ] 画像データの適切なクリーンアップ確認
  - [ ] HTTPエンドポイントのセキュリティ検証
  - [ ] 異常系でのリソースリーク確認
  - [ ] 負荷テスト（同時接続5件）
  - **推定工数**: 1.5日
  - **依存関係**: TASK-901

- [ ] **TASK-903**: 依存関係・パッケージ管理
  - [ ] `pyproject.toml` に新しい依存関係追加
  - [ ] オプション依存関係の設定（[visualization], [streaming]）
  - [ ] バージョン固定・セキュリティ監査
  - **推定工数**: 0.5日
  - **依存関係**: 全フェーズ

---

## フェーズ10: ドキュメント・運用準備 (Week 10)

- [ ] **TASK-1001**: API・使用方法ドキュメント更新
  - [ ] `docs/api.md` に新しいパラメータ・エンドポイント追記
  - [ ] `docs/usage.md` に画像生成機能の使用例追加
  - [ ] `README.md` にクイックスタートガイド更新
  - **推定工数**: 1日
  - **依存関係**: TASK-804

- [ ] **TASK-1002**: サンプル・デモ準備
  - [ ] 画像生成機能のサンプルスクリプト作成
  - [ ] MCPクライアント向けの実装例
  - [ ] トラブルシューティングガイド作成
  - **推定工数**: 1.5日
  - **依存関係**: TASK-1001

- [ ] **TASK-1003**: リリース準備・検収
  - [ ] バージョン更新（0.4.0）・CHANGELOG作成
  - [ ] 全機能の受入テスト実行
  - [ ] パフォーマンス・品質指標の最終確認
  - **推定工数**: 1日
  - **依存関係**: TASK-902, TASK-1002

---

## 拡張マイルストーン

| マイルストーン | 目標週 | 完了条件 |
|---------------|-------|----------|
| MS-6 | Week 6 | 画像生成機能が基本グラフタイプで動作（TASK-601〜603） |
| MS-7 | Week 7 | HTTPストリーミング配信が完全動作（TASK-701〜704） |
| MS-8 | Week 8 | MCPツール拡張が後方互換性を保って完了（TASK-801〜804） |
| MS-9 | Week 9 | 全機能統合・品質基準クリア（TASK-901〜903） |
| MS-10 | Week 10 | リリース準備完了・検収パス（TASK-1001〜1003） |

---

## 技術リスク・対策

| リスク項目 | 影響度 | 対策 |
|-----------|-------|------|
| matplotlib日本語フォント問題 | 中 | フォント自動検出・フォールバック実装 |
| HTTPストリーミング性能不足 | 高 | 非同期処理・チャンクサイズ最適化 |
| メモリ使用量超過 | 中 | キャッシュサイズ制限・定期クリーンアップ |
| MCPクライアント互換性 | 低 | 段階的機能有効化・後方互換性維持 |

---

## 追加依存関係

```toml
# pyproject.toml 追加予定
[tool.poetry.dependencies]
matplotlib = "^3.8.0"
pillow = "^10.0.0"
fastapi = "^0.100.0"
uvicorn = "^0.23.0"
cachetools = "^5.3.0"

[tool.poetry.extras]
visualization = ["matplotlib", "pillow"]
streaming = ["fastapi", "uvicorn", "cachetools"]
full = ["matplotlib", "pillow", "fastapi", "uvicorn", "cachetools"]
```

---

## 更新チェックリスト（拡張）

既存チェックリストに加えて：

- [ ] 画像生成時の日本語フォント表示確認（NFR-007）
- [ ] HTTPエンドポイント・セキュリティ設定確認
- [ ] 画像キャッシュのメモリ使用量監視（NFR-005）
- [ ] ストリーミング性能・転送速度確認（NFR-006）
- [ ] MCPクライアント各種での動作確認（NFR-008）

---

## 拡張進捗ログ

| 日付       | 内容                                                                 |
| ---------- | -------------------------------------------------------------------- |
| 2025-10-03 | DataLoader リファクタ・例外統一・追加カバレッジテスト                |
| 2025-10-04 | レガシーコード削除 / 依存最小化 / キャッシュ統計追加 / tasks.md 更新 |
| 2025-10-04 | 画像生成・HTTPストリーミング機能の実装計画追加（FR-004〜FR-006対応） |

---

**作成日**: 2025年10月03日  
**最終更新**: 2025年10月04日  
**プロジェクトマネージャー**: GitHub Copilot (AI assistant)
