# デモシナリオ・受入テストガイド

- **バージョン**: 1.0.0
- **更新日**: 2025-10-30
- **対象**: Household Budget Analysis MCP Server
- **目的**: 実環境でのデモンストレーションと受入テスト用シナリオ

---

## 事前準備

### 環境セットアップ

```bash
# 1. リポジトリのクローン
git clone https://github.com/raoshun/my_household_mcpserver.git
cd my_household_mcpserver

# 2. Python環境の準備（Python 3.12以上）
python --version  # 3.12以上であることを確認

# 3. 依存パッケージのインストール（全機能）
uv pip install -e ".[full]"

# 4. 日本語フォントの配置（既に含まれている場合はスキップ）
# fonts/NotoSansCJKjp-Regular.otf が存在することを確認
ls -lh fonts/NotoSansCJKjp-Regular.otf
```

### サンプルデータの確認

```bash
# data/ ディレクトリのCSVファイル確認
ls data/*.csv | head -5
# 出力例:
# data/収入・支出詳細_2024-01-01_2024-01-31.csv
# data/収入・支出詳細_2024-02-01_2024-02-29.csv
# ...
```

---

## シナリオ1: 基本的な月次確認（10分）

### 目的

最も基本的な使用例として、先月の支出状況を確認します。

### 実行手順

#### 1.1 MCPサーバーの起動（stdioモード）

```bash
python -m src.household_mcp.server
# または
python -c "from household_mcp.server import mcp; mcp.run()"
```

#### 1.2 月次データ取得（テキスト形式）

MCPクライアント（Claude Desktop等）から以下のように問いかけます：

**ユーザー**: 「2024年10月の支出を教えて」

**期待される動作**:

- `get_monthly_household` ツールが呼び出される
- 2024年10月のCSVデータが読み込まれる
- カテゴリ別の支出一覧が返される

**確認ポイント**:

- [ ] データが正しく読み込まれる
- [ ] カテゴリ別の金額が表示される
- [ ] 総支出額が計算される
- [ ] エラーが発生しない

#### 1.3 複数月の比較

**ユーザー**: 「9月と10月の支出を比較して」

**期待される動作**:

- 両月のデータが取得される
- 増減が計算される
- 主要な変化が報告される

**確認ポイント**:

- [ ] 2ヶ月分のデータが正しく取得される
- [ ] 差額・増減率が計算される
- [ ] わかりやすい説明が生成される

---

## シナリオ2: カテゴリ別トレンド分析（15分）

### 目的

特定カテゴリの時系列推移を分析し、傾向を把握します。

### 実行手順

#### 2.1 食費のトレンド確認（テキスト形式）

**ユーザー**: 「食費の過去6ヶ月の推移を教えて」

**期待される動作**:

- `get_category_trend` ツールが呼び出される
- start_month, end_month が自動計算される
- 月次推移データが返される

**確認ポイント**:

- [ ] 指定期間のデータが取得される
- [ ] 前月比（MoM）が計算される
- [ ] 前年同月比（YoY）が計算される
- [ ] 12ヶ月移動平均が計算される（データがある場合）

#### 2.2 複数カテゴリの比較

**ユーザー**: 「食費と交際費の推移を比較して」

**期待される動作**:

- 両カテゴリのトレンドデータが取得される
- 比較分析が行われる

**確認ポイント**:

- [ ] 複数カテゴリのデータが取得される
- [ ] それぞれのトレンドが分析される
- [ ] 比較所見が提示される

---

## シナリオ3: 画像生成とビジュアル分析（20分）

### 目的

グラフを生成し、視覚的にデータを理解します。

### 実行手順

#### 3.1 HTTPストリーミングモードでの起動

```bash
# 別のターミナルで実行
python -m src.household_mcp.server --transport streamable-http --port 8000
```

#### 3.2 円グラフでの月次サマリー

**ユーザー**: 「10月の支出構成を円グラフで見せて」

**期待される動作**:

- `get_monthly_household` が `output_format="image"` で呼び出される
- 円グラフが生成される
- 画像URLが返される

**確認ポイント**:

- [ ] 画像が3秒以内に生成される
- [ ] 日本語ラベルが正しく表示される（文字化けなし）
- [ ] カテゴリの色分けが視認しやすい
- [ ] URLで画像にアクセスできる

**手動確認**:

```bash
# ブラウザまたはcurlで画像を取得
curl http://localhost:8000/api/charts/{返されたchart_id} --output demo_pie.png
```

#### 3.3 棒グラフでのトレンド表示

**ユーザー**: 「食費の半年トレンドを棒グラフで見せて」

**期待される動作**:

- `get_category_trend` が `output_format="image"`, `graph_type="bar"` で呼び出される
- 棒グラフが生成される

**確認ポイント**:

- [ ] 月ごとの推移が視覚化される
- [ ] 金額の大小が一目でわかる
- [ ] 軸ラベルが日本語で表示される

#### 3.4 キャッシュの確認

同じパラメータで再度リクエスト：

**ユーザー**: 「もう一度10月の円グラフを見せて」

**確認ポイント**:

- [ ] 2回目は0.5秒以内に返される（キャッシュヒット）
- [ ] 同じ chart_id が返される
- [ ] 画像内容が同一である

**キャッシュ統計の確認**:

```bash
curl http://localhost:8000/api/cache/stats
# 出力例: {"hits": 1, "misses": 2, "hit_rate": 0.333, ...}
```

---

## シナリオ4: カテゴリ分析と詳細確認（15分）

### 目的

特定カテゴリの詳細分析を行い、異常値や傾向を発見します。

### 実行手順

#### 4.1 食費の詳細分析

**ユーザー**: 「食費を過去3ヶ月で詳しく分析して」

**期待される動作**:

- `category_analysis` ツールが呼び出される
- 合計・平均・最大最小が計算される
- 日本語サマリーが生成される

**確認ポイント**:

- [ ] 期間の合計支出が正しい
- [ ] 月平均が計算される
- [ ] 最大月・最小月が特定される
- [ ] 月次内訳データが返される

#### 4.2 カテゴリの検索

**ユーザー**: 「食に関連するカテゴリを全て教えて」

**期待される動作**:

- `find_categories` ツールが呼び出される
- 部分一致でカテゴリが検索される

**確認ポイント**:

- [ ] 「食費」「外食」などが抽出される
- [ ] 検索機能が正常に動作する

---

## シナリオ5: エラーハンドリングと異常系（10分）

### 目的

エラーケースでの動作を確認し、適切なメッセージが返されることを検証します。

### 実行手順

#### 5.1 存在しない月の指定

**ユーザー**: 「2030年1月の支出を教えて」

**期待される動作**:

- データが存在しないことが検出される
- 日本語のエラーメッセージが返される

**確認ポイント**:

- [ ] 「データが存在しません」などの明確なメッセージ
- [ ] エラーメッセージが日本語である
- [ ] システムがクラッシュしない

#### 5.2 存在しないカテゴリの指定

**ユーザー**: 「架空カテゴリの推移を教えて」

**確認ポイント**:

- [ ] カテゴリが見つからない旨が通知される
- [ ] 類似カテゴリの提案がある（理想）
- [ ] 利用可能なカテゴリリストが提示される

#### 5.3 不正なパラメータ

**ユーザー**: 「-1月のデータを教えて」（意図的に不正な入力）

**確認ポイント**:

- [ ] バリデーションエラーが返される
- [ ] エラー内容がわかりやすい
- [ ] システムが停止しない

---

## シナリオ6: パフォーマンス検証（15分）

### 目的

大量データや複雑なクエリでのパフォーマンスを確認します。

### 実行手順

#### 6.1 初回データロードの速度

```bash
# タイミング計測付きでサーバー起動
time python -c "
from household_mcp.dataloader import HouseholdDataLoader
loader = HouseholdDataLoader('data')
df = loader.load_csv_from_month(2024, 10)
print(f'Loaded {len(df)} rows')
"
```

**確認ポイント**:

- [ ] 初回ロードが2秒以内
- [ ] データ量が適切に表示される

#### 6.2 キャッシュ効果の測定

```bash
# 2回目の実行
time python -c "
from household_mcp.dataloader import HouseholdDataLoader
loader = HouseholdDataLoader('data')
df = loader.load_csv_from_month(2024, 10)
print(f'Loaded {len(df)} rows')
stats = loader.cache_stats()
print(f'Cache hits: {stats[\"hits\"]}, misses: {stats[\"misses\"]}')
"
```

**確認ポイント**:

- [ ] 2回目が0.5秒以内（キャッシュヒット）
- [ ] キャッシュヒット数が増加している

#### 6.3 画像生成のパフォーマンス

**ユーザー**: 「10月の円グラフを生成して」（初回）

```bash
# サーバーログで生成時間を確認
# または、ベンチマークスクリプトを実行
python scripts/benchmark_performance.py
```

**確認ポイント**:

- [ ] 初回生成が3秒以内
- [ ] メモリ使用量が50MB以内
- [ ] 2回目（キャッシュヒット）が0.5秒以内

#### 6.4 複数年データの処理

3年分（36ファイル）のデータでの動作確認：

**ユーザー**: 「食費の3年間の推移を分析して」

**確認ポイント**:

- [ ] 大量データが正常に処理される
- [ ] レスポンスが妥当な時間内（10秒以内）
- [ ] メモリエラーが発生しない

---

## シナリオ7: Claude Desktop統合（20分）

### 目的

実際のLLMクライアントでの使用感を確認します。

### 実行手順

#### 7.1 Claude Desktop設定

`~/Library/Application Support/Claude/claude_desktop_config.json` に追加:

```json
{
  "mcpServers": {
    "household": {
      "command": "python",
      "args": ["-m", "src.household_mcp.server"],
      "cwd": "/path/to/my_household_mcpserver"
    }
  }
}
```

#### 7.2 自然な会話フロー

以下のような自然な会話を試します：

1. **ユーザー**: 「先月の支出を教えて」
   - 確認: データが取得される

2. **ユーザー**: 「食費が多すぎない?」
   - 確認: 過去データとの比較が行われる

3. **ユーザー**: 「どのカテゴリを節約すべき?」
   - 確認: 分析結果に基づいた提案がなされる

4. **ユーザー**: 「食費の推移をグラフで見せて」
   - 確認: 画像が生成・表示される

5. **ユーザー**: 「このペースだと年間でいくらになる?」
   - 確認: 計算と予測が行われる

**確認ポイント**:

- [ ] 会話の文脈が維持される
- [ ] 適切なツールが選択される
- [ ] 自然な日本語で応答される
- [ ] グラフが必要な場面で自動生成される

---

## 成功基準

### 必須（Must Have）

以下の全シナリオが問題なく完了すること：

- [x] シナリオ1: 基本的な月次確認
- [x] シナリオ2: カテゴリ別トレンド分析
- [x] シナリオ5: エラーハンドリング

### 推奨（Should Have）

以下の80%以上が問題なく完了すること：

- [x] シナリオ3: 画像生成とビジュアル分析
- [x] シナリオ4: カテゴリ分析と詳細確認
- [x] シナリオ6: パフォーマンス検証

### オプション（Nice to Have）

- [ ] シナリオ7: Claude Desktop統合

---

## トラブルシューティング

### よくある問題と対処法

#### 問題1: 日本語が文字化けする

```bash
# フォントファイルの確認
ls -lh fonts/NotoSansCJKjp-Regular.otf

# 再配置が必要な場合
wget https://github.com/googlefonts/noto-cjk/raw/main/Sans/OTF/Japanese/NotoSansCJKjp-Regular.otf -O fonts/NotoSansCJKjp-Regular.otf
```

#### 問題2: 画像が生成されない

```bash
# visualization extrasの確認
python -c "from household_mcp.visualization import ChartGenerator; print('OK')"

# 必要に応じて再インストール
uv pip install -e ".[visualization]"
```

#### 問題3: HTTPサーバーが起動しない

```bash
# streaming extrasの確認
python -c "from household_mcp.streaming import ImageStreamer; print('OK')"

# 必要に応じて再インストール
uv pip install -e ".[streaming]"
```

#### 問題4: テストが失敗する

```bash
# 依存関係の再インストール
uv pip install -e ".[dev,full]"

# テストの再実行
pytest tests/ -v

# 特定のテストのみ
pytest tests/unit/test_chart_generator.py -v
```

---

## デモ実施チェックリスト

### 事前準備

- [ ] Python 3.12以上の環境準備
- [ ] プロジェクトのクローンと依存パッケージインストール
- [ ] サンプルCSVデータの配置確認
- [ ] 日本語フォントの配置確認
- [ ] 全テストの実行とPASS確認

### デモ実施

- [ ] シナリオ1実施（10分）
- [ ] シナリオ2実施（15分）
- [ ] シナリオ3実施（20分）
- [ ] シナリオ4実施（15分）
- [ ] シナリオ5実施（10分）
- [ ] シナリオ6実施（15分）
- [ ] シナリオ7実施（20分）※オプション

### 事後確認

- [ ] デモ中に発生した問題の記録
- [ ] パフォーマンス測定結果の記録
- [ ] ユーザーフィードバックの収集
- [ ] 改善点のリストアップ

---

## 受入判定

### 合格基準

- 必須シナリオ（1, 2, 5）が全て成功
- 推奨シナリオ（3, 4, 6）の80%以上が成功
- クリティカルなエラーが発生しない
- パフォーマンス基準を満たす（NFR-005, NFR-006）

### 条件付き合格基準

- 必須シナリオが全て成功
- 推奨シナリオの60%以上が成功
- 発生した問題に対する修正計画が明確

### 不合格基準

- 必須シナリオのいずれかが失敗
- クリティカルなエラーが複数発生
- パフォーマンス基準を大幅に下回る

---

## 参考資料

- [UAT_CHECKLIST.md](./UAT_CHECKLIST.md) - 詳細チェックリスト
- [requirements.md](./requirements.md) - 機能要件
- [design.md](./design.md) - 技術設計
- [README.md](./README.md) - インストール手順
- [docs/examples.md](./docs/examples.md) - サンプル会話例
- [docs/FAQ.md](./docs/FAQ.md) - よくある質問
